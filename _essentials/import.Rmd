---
title: "Importing files, with solutions (ds4psy)"
author: "Hansjörg Neth, SPDS, uni.kn"
date: "2018 12 15"
output:
   rmdformats::html_clean: # html_clean html_docco readthedown material #
     code_folding: show # hide
     toc_float: true
     toc_depth: 3
     highlight: default # textmate default kate haddock monochrome #
     lightbox: true # true by default
     fig_width: 7 # in inches
editor_options: 
  chunk_output_type: console # inline
---

<!-- Example of essential commands | ds4psy: Winter 2018 -->

```{r preamble, echo = FALSE, eval = TRUE, cache = FALSE, message = FALSE, warning = FALSE}
## (a) Housekeeping: -----
rm(list=ls()) # clean all.

## (b) Current file name and path: ----- 
# my_path <- dirname(rstudioapi::getActiveDocumentContext()$path)
# my_path
# setwd(my_path) # set to current directory
setwd("~/Desktop/stuff/Dropbox/_code/R/_teachR/ds4psy/_essentials") # set to current directory
# list.files() # all files + folders in current directory
fileName <- "import.Rmd"

## (c) Packages: ----- 
library(knitr)
library(rmdformats)
library(tidyverse)

## (d) Global options: ----- 
options(max.print = "75")
opts_chunk$set(echo = TRUE,
	             cache = TRUE,
               prompt = FALSE,
               tidy = FALSE,
               collapse = TRUE, # set TRUE in answers 
               comment = "#>",
               message = FALSE,
               warning = FALSE,
               ## Default figure options:
               fig.width = 7, 
               fig.asp = .618, # golden ratio
               out.width = "75%",
               fig.align = "center"
               )
opts_knit$set(width = 75)

## (e) Custom functions: ----- 
source(file = "~/Desktop/stuff/Dropbox/_code/R/_teachR/ds4psy/R/custom_functions.R")
```

# Introduction

This file contains **essential commands** from [Chapter 11: Data import](https://r4ds.had.co.nz/data-import.html) of the textbook [r4ds](http://r4ds.had.co.nz) and corresponding examples and exercises. A command is considered "essential" when you really need to _know_ it and need to know _how to use_ it to succeed in this course. 

<!-- Table with links: -->

All [ds4psy](http://rpository.com/ds4psy/) essentials so far: 

Nr. | Topic       |
---:|:------------| 
0.  | [Syllabus](http://rpository.com/ds4psy/) | 
1.  | [Basic R concepts and commands](http://rpository.com/ds4psy/essentials/basics.html) | 
2.  | [Visualizing data](http://rpository.com/ds4psy/essentials/visualize.html) | 
3.  | [Transforming data](http://rpository.com/ds4psy/essentials/transform.html) |
4.  | [Exploring data (EDA)](http://rpository.com/ds4psy/essentials/explore.html) | 
5.  | [Tibbles](http://rpository.com/ds4psy/essentials/tibbles.html) |
6.  |  **Importing data** |
+.  | [Datasets](http://rpository.com/ds4psy/essentials/datasets.html) | 

<!--
Nr. | Topic       |
---:|:------------| 
0.  | [Syllabus](http://rpository.com/ds4psy/) | 
1.  | [Basic R concepts and commands](http://rpository.com/ds4psy/essentials/basics.html) | 
2.  | [Visualizing data](http://rpository.com/ds4psy/essentials/visualize.html) | 
3.  | [Transforming data](http://rpository.com/ds4psy/essentials/transform.html) |
4.  | [Exploring data (EDA)](http://rpository.com/ds4psy/essentials/explore.html) | 
5.  | [Tibbles](http://rpository.com/ds4psy/essentials/tibbles.html) |
6.  | [Importing data](http://rpository.com/ds4psy/essentials/import.html) |
7.  | [Tidying data](http://rpository.com/ds4psy/essentials/tidy.html) |
+.  | [Datasets](http://rpository.com/ds4psy/essentials/datasets.html) | 
-->

## Course coordinates

<!-- uni.kn logo and link to SPDS: -->  
<!-- ![](./inst/pix/uniKn_logo.png) --> 
<a href="https://www.spds.uni-konstanz.de/">
<img src = "../inst/pix/uniKn_logo.png" alt = "spds.uni.kn" align = "right" width = "300" style = "width: 300px; float: right; border:20;"/>
<!-- <img src = "./inst/pix/uniKn_logo_s.png" alt = "spds.uni.kn" style = "float: right; border:20;"/> --> 
</a>

* Taught at the [University of Konstanz](https://www.uni-konstanz.de/) by [Hansjörg Neth](http://neth.de/) (<h.neth@uni.kn>,  [SPDS](https://www.spds.uni-konstanz.de/), office D507).
* Winter 2018/2019: Mondays, 13:30--15:00, C511. 
* Links to current [course syllabus](http://rpository.com/ds4psy/) | [ZeUS](https://zeus.uni-konstanz.de/hioserver/pages/startFlow.xhtml?_flowId=detailView-flow&unitId=5101&periodId=78&navigationPosition=hisinoneLehrorganisation,examEventOverviewOwn) |  [Ilias](https://ilias.uni-konstanz.de/ilias/goto_ilias_uni_crs_809936.html) 


## Preparations

Create an R script (`.R`) or an R-Markdown file (`.Rmd`) and load the R packages of the `tidyverse`. (**Hint:** Structure your script by inserting spaces, meaningful comments, and sections.) 

```{r layout_template, echo = TRUE, eval = FALSE}
## Importing data | ds4psy
## 2018 12 17
## ----------------------------

## Preparations: ----------

library(tidyverse)

## 1. Topic: ----------

# etc.

## End of file (eof). ----------  
```

To use [R Markdown](https://rmarkdown.rstudio.com), create a corresponding file and save it with the `.Rmd` extension (e.g., by selecting `File > New File > R Markdown`). 
For instructions on combining text and code, see [Chapter 27: R Markdown](https://r4ds.had.co.nz/r-markdown.html) of our textbook, or use one of the following templates:  

- minimal template:  `rmd_template_s` [in [.Rmd](http://rpository.com/down/temp/rmd_template_s.Rmd) | [.html](http://rpository.com/down/temp/rmd_template_s.html) format]

- medium template: `rmd_template_m` [in [.Rmd](http://rpository.com/down/temp/rmd_template_m.Rmd) | [.html](http://rpository.com/down/temp/rmd_template_m.html) format]

- explicit explanations: `Rmarkdown_basics` [in [.Rmd](http://rpository.com/down/temp/Rmarkdown_basics.Rmd) | [.html](http://rpository.com/down/temp/Rmarkdown_basics.html) format]

**Hint:** Try to _knit_ your `.Rmd` file immediately after saving it and marvel at the beauty of the resulting `.html`-file. If this works, keep doing this routinely from now on, putting all your R-code into code chunks, and any text (like headings or conclusions) that describes or explains what you are doing outside of them. From now on, you can share your `.html` output files, rather than your `.Rmd` source files when showing off your R and data science skills.


# Importing data

Where does data (e.g., a _data frame_ or _tibble_) come from? If we don't enter it ourselves (e.g., with the `tibble` or `tribble` commands (see our session on [Tibbles](http://rpository.com/ds4psy/essentials/tibbles.html)) we usually import it from an external source. The scope of such sources is vast and here we only cover the most common candidates: Data that is already stored in text form or other file formats that can easily be coerced into linear or rectangular data structures. 

This session discusses options and potential pitfalls when using the tidyverse package `readr` for data import. `readr` provides a fast and friendly way to read vectors and rectangular data files (like `csv`, `tsv`, and `fwf`).

## File names and paths

An important pre-requisite to loading data is that we are able to orient ourselves on our computer and can navigate or point to the location at which data files may be stored. Two important questions to ask and answer prior to reading or writing data is: 

- Where am I?  
- Where is my data?  

#### Working directory

The 1st questions ("Where am I?") addresses the notion of the current _working directory_. 
This is typically the directory on your computer in which you started your R environment, the location of your current R script, or -- if you're working with [RStudio](https://www.rstudio.com/) _projects_ -- the home directory of your current project. Use the function `getwd` to find out your current working directory:  

```{r getwd}
# Get current working directory (wd):
my_wd <- getwd()
my_wd 
```

Note that `getwd` function returns a character string and -- depending on your operating system -- uses either forward slashes (`/`) or backward slashes (`\`) to separate the hierarchy levels of different directories. This character string represents the address of your current working directory.

Corresponding to `getwd`, the function `setwd` (with its only argument `dir` specifying a string that points to an existing location on your computer) allows changing your current working directory to `dir`:

```{r setwd}
# Set current working directory:
setwd(dir = my_wd)  # set dir to my_wd (set above)  
getwd()             # same dir (as set to my_wd)
```

And `list.files()` provides a list of all files and directories in the current working directory:

```{r list.files, eval = FALSE}
# List files and directories: 
list.files()       # in current working directory
list.files(my_wd)  # in some specific directory
```

#### File paths

The 2nd question ("Where is my data?") implies that data doesn't necessarily need to be stored at the same location as our current working directory. Let's suppose that we want to load some data file (called `data_t1.csv`), which we  downloaded from an online source at <http://rpository.com/ds4psy/data/data_t1.csv>. But rather than saving it in our current working directory `my_wd`, the file `data_t1.csv` is stored in some parallel directory (called `data`). 
In this case, there are 2 principle ways to load our data file:

1. Change our current working directory to the data directory: 

```{r}
# (1) Changing working directory to load data: 

# Get working directory:
my_wd <- getwd()
my_wd  # prints the current wd:

# Change current working directory: 
setwd("/Users/hneth/Desktop/stuff/Dropbox/_code/R/_teachR/ds4psy/data")
getwd()

# Read data from the NEW working directory: 
t1 <- read_csv("data_t1.csv")  # read csv data file

# Return to the original working directory: 
setwd(my_wd)  # setwd to original directory
getwd()       # back in my_wd
```

2. Keep our current working directory, but read the data from a different directory:

```{r}
# (2) Reading data from another directory:

# (a) provide absolute/full path of the data file:
t2 <- read_csv("/Users/hneth/Desktop/stuff/Dropbox/_code/R/_teachR/ds4psy/data/data_t1.csv")

# (b) provide relative path of the data file:
t3 <- read_csv("./../data/data_t1.csv")

# (c) relative to (platform dependent) home directory:
t4 <- read_csv("~/Desktop/stuff/Dropbox/_code/R/_teachR/ds4psy/data/data_t1.csv")

# (d) provide path to an online source of the data file:
t0 <- read_csv("http://rpository.com/ds4psy/data/data_t1.csv")
```

We see that there are many different ways of pointing to the location of a data file. Due to this flexibility, it's typically best to not change our working directory to load data, but rather reading the file from a different directory. 
Let's verify that all of the above methods actually loaded the same data:

```{r}
# Check whether t0 to t4 are all equal:
all.equal(t0, t1) & 
all.equal(t1, t2) & 
all.equal(t2, t3) & 
all.equal(t3, t4)
```

### Sharing scripts and data files

To share your R scripts and data files with others it is best to work with an [RStudio](https://www.rstudio.com/) _project_ and store all scripts and files within this project. Alternatively, keep all your R scripts in a specific directory (e.g., called `R`), and read all data files from either the same or some dedicated data directory (e.g., `data`). Importantly, using only _relative_ file paths (i.e., relative to the current script or to the project's working directory) also allows transferring your scripts and data files. By archiving your entire project folder (e.g., as `my_project.zip`, or a folder that includes the subfolders `R` and `data`), you can transfer your archive to another person or computer and the scripts will keep working. 


## Parsing vectors

The process of reading some data structure is known as _parsing_. We usually want to parse entire files of data. However, as our data files typically consist of columns of variables, we also need to consider how individual vectors are parsed.

We only cover the most common `parse` commands here (see [11.3 Parsing a vector](https://r4ds.had.co.nz/data-import.html#parsing-a-vector) for details).  

The `parse_` functions provided by `readr` take a _character_ vector as their main input argument and return a more specialised vector (e.g., logical, integer, or date) as output vector. Some examples are: 

```{r}
# Parse logical values:
v1 <- parse_logical(c("TRUE", "FALSE", "NA", "TRUE"))
v1
str(v1)

# Parse integers:
v2 <- parse_integer(c("1", "2", "3", "NA", "5"))
v2
str(v2)

# Parse doubles:


# Parse dates: 
v3 <- parse_date(c("2018-12-17", "2018-12-24", "NA", "2018-12-31"))
v3
str(v3)
```

A uniform `na` argument allows specifying which string should be treated as missing data: 
  
```{r}
parse_integer(c("12", "34", "?", "78"), na = "?")
```

If the process of parsing fails for an element, a _warning_ is issued and the problematic element is missing (`NA`) in the output vector:

```{r}
v4 <- parse_integer(c("12", "34", "xy", "78"))
v4
```

We can use `problems()` on the parsed vector to see which problems occurred during parsing:

```{r}
problems(v4)
```

The range of important parsers matches the range of data types that we typically deal with. Important parsers include the following:

1. `parse_logical()` parses logical values (`TRUE` vs. `FALSE`); 

2. `parse_integer()` parses integer numbers (`r 1:3`, etc.); 

3. `parse_double()` is a strict numeric parser; 

```{r}
parse_double(as.character(1:3))
parse_double(c("1.23", "3.14"))
```

When using a _decimal mark_ different from "." (used in the U.S.) we need to specify this by providing the `locale` argument: 

```{r}
parse_double(c("1,23", "3,14"))  # issues a warning

parse_double(c("1,23", "3,14"), locale = locale(decimal_mark = ","))  # works
```

4. `parse_number()` is a more flexible numeric parser, which ignores prefixes and postfixes, but only reads the first number of a character string:

```{r}
parse_number(c("1%", "is less than 2%", "and 3% is less than 4%"))
```

In addition, `parse_number` allows specifying both a `decimal_mark` and `grouping_mark` in its `locale` argument for reading country-specific number formats: 

```{r}
# Used in the US: 
parse_number("$1,000.99")

# Used in Germany (and the EU): 
parse_number("EUR1.000,99", locale = locale(decimal_mark = ",", grouping_mark = "."))

# Used in Switzerland:
parse_number("CHF1'000,99", locale = locale(decimal_mark = ",", grouping_mark = "'"))
```

5. `parse_character()` seems trivial, but allows dealing with different character encodings:

```{r}
parse_character(c("très difficile", "mon chérie"), 
                locale = locale(encoding = "UTF-8"))
parse_character("\x82\xb1\x82\xf1\x82\xc9\x82\xbf\x82\xcd", 
                locale = locale(encoding = "Shift-JIS"))

french <- "très difficile"
parse_character(french, locale = locale(encoding = "UTF-8"))
guess_encoding(charToRaw("très difficile"))
```

6. `parse_factor()` creates factors, a data structure often used to represent categorical variables with fixed and known values (e.g., the different conditions or treatment levels of an experiment): 

```{r}
treatments <- c("therapy", "medication", "placebo")  # define factor levels

parse_factor(c("medication", "placebo", "therapy", "medication"), levels = treatments)
```

7. `parse_datetime()`, `parse_date()`, and `parse_time()` allow parsing various date and time specifications.

```{r}
# Current date and time:
Sys.Date()
Sys.time()

parse_date(c("2018-12-17", "2018-12-24", "2018-12-31"))
parse_datetime("2018-12-17 07:38:01", locale = locale("de"))
```

Reading dates and times often requires specifying the details of the current date-time `format` (see the documentation to `?parse_datetime` for details). 

In R, _dates_ are typically represented by a 4-digit year (`%Y`), a 2-digit month (`%m`), and a 2-digit day (`%d`), all separated by either "-" or "/":

```{r}
parse_date("2018/12/10")
parse_date("2018-12-10")
```

Note the ambiguity of a date string like `"2018-12-10"` (in which month and day could be confused) or even `"08/10/12"` (in which even the year is unclear):

```{r}
# When was "2018-12-10"?
parse_date("2018-12-10", format = "%Y-%m-%d")
parse_date("2018-12-10", format = "%Y-%d-%m")

# When was "08/10/12"?
parse_date(c("08/10/12"), "%d/%m/%y")
parse_date(c("08/10/12"), "%m/%d/%y")
parse_date(c("08/10/12"), "%y/%m/%d")
parse_date(c("08/10/12"), "%y/%d/%m")
```

## Parsing files

+++ here now +++

Loading a data file 

### 1. `read_csv`

What’s the difference between read_csv() and read_csv2()?

?read_csv2()

`read_csv()` and `read_tsv()` are special cases of the general `read_delim()`.
They're useful for reading the most common types of flat file data, 
comma separated values and tab separated values, respectively.

`read_csv2()` uses ";" for separators, instead of ",". 
This is common in European countries which use , as the decimal separator.


### 2. `read_csv2`

### 3. `read_delim`

```{r create_data_delim}
# Create data (with NA values): 
set.seed(2)
n <- 100
v1 <- random_symbols(n = n, set = LETTERS, len = 2)
v2 <- round(runif(n = n, min = 18, max = 88), 0)
v3 <- add_whats(vec = random_symbols(n = n, set = as.character(0:9), len = 8), 
                amount = .05, what = -99)  # add -99 as NA values

v4 <- add_whats(vec = random_symbols(n = n, set = c(letters, LETTERS), len = 6), 
                amount = .10, what = -77)  # add -77 as NA values

tbl_1 <- tibble(initials = v1,
                age = v2,
                tel = as.numeric(v3),
                pwd = v4)
tbl_1

# Writing out: 
write_delim(tbl_1, path = "../data/data_1.dat", delim = ".", na = "NA", col_names = FALSE)

# Reading in:
my_file <- "../data/data_1.dat"

# Reading back in:

# (a) read_delim: 
data_1 <- read_delim(my_file, delim = ".", 
                     col_names = c("initials", "age", "tel", "pwd"), 
                     na = c("-77", "-99"))
sum(is.na(data_1))  # 15 NA values
data_1


# Check equality: 
all.equal(tbl_1, data_1)

# Hypothesis: Differences come from different NA encodings.

# Recode -99 and -77 in tbl_1 as NA:
tbl_1[tbl_1 == -99] <- NA
tbl_1[tbl_1 == "-77"] <- NA
sum(is.na(tbl_1))

# Check equality: 
all.equal(tbl_1, data_1)  # TRUE (qed).
```

### 4. `read_fwf`

```{r create_data_fwf}
# Create data (without NA values): 
set.seed(3)
n <- 100
v1 <- random_symbols(n = n, set = LETTERS, len = 2)
v2 <- round(runif(n = n, min = 18, max = 80), 0)
v3 <- random_symbols(n = n, set = as.character(0:9), len = 4)
v4 <- random_symbols(n = n, set = c(letters, LETTERS), len = 6)

tbl_2 <- tibble(ini = v1,
                age = v2,
                tel = v3,
                pwd = v4)
tbl_2

# Writing out: 
write_delim(tbl_2, path = "../data/data_2.dat", delim = "$", na = "NA", col_names = FALSE)

# (b) read_fwf: 
data_2 <- read_fwf("../data/data_2.dat", 
                   fwf_cols(ini = c(1, 2), 
                            age = c(4, 5), 
                            tel = c(7, 10), 
                            pwd = c(12, 17)))

data_2

# Check equality: 
all.equal(tbl_2, data_2)
```




## Writing files


## Importing data from other programs

For _rectangular_ data: 

### From Excel (`xls`)

`readxl` reads excel files (both .xls and .xlsx).

### From SPSS (`sav`)

`haven` reads SPSS, Stata, and SAS files.


For _hierarchical_ data: 

Use `jsonlite` for json, and `xml2` for XML. 



# Exercises (WPA06)

<!-- 

## Agenda

**ToDo:**

- Import the same table from different data formats (e.g., US vs. EU)

- Import a table with corrupt variables and values (e.g., "ten" as a number)

- Realize the limitations of rectangular data (e.g., multiple entries per cell, multiple dependent variables, etc.)

--> 

## Exercise 1

1. Find out your current working directory and list all files and folders contained in it. 

```{r ex1_getwd, echo = TRUE, eval = TRUE}
my_wd <- getwd()
my_wd

list.files(my_wd)
```

2. Change your working directory and list all the files and folders in this directory.

```{r ex1_setwd, echo = TRUE, eval = TRUE}
setwd("./../data")
getwd()
list.files()
```

3. Return to your original working directory. 

```{r ex1_setwd_back, echo = TRUE, eval = TRUE}
setwd(my_wd)
getwd()
```

## Exercise 2

Look at your ID card and type your birthday as a string as it's written on the card (including any spaces or punctuation symbols). For instance, if you were Erika Mustermann (see <https://de.wikipedia.org/wiki/Personalausweis_(Deutschland)>) you would write the character string "12.08.1964". 

1. Use an appropriate `parse_` command to read this character string into R. 

2. Now read out the date in German (i.e., "12. August 1964") and use another command to parse this string into R. 

3. Use [Google Translate](https://translate.google.com/) to translate this character string into French, Italian, and Spanish and use appropriate R commands to parse these strings into R. 

**Hint:** Consult `vignette("locales")` for specifying languages. 

```{r birthday, echo = TRUE, eval = TRUE}
parse_date("12.08.1964", "%d.%m.%Y")

parse_date("12. August 1964", "%d. %B %Y", locale = locale("de"))

parse_date("12. août 1964", "%d. %B %Y", locale = locale("fr"))
parse_date("12. Agosto 1964", "%d. %B %Y", locale = locale("it"))
parse_date("12 de agosto de 1964.", "%d de %B de %Y.", locale = locale("es"))
```




Use a `parse_` command (with an appropriate `locale`) to parse the following character strings into the desired data format: 

- `"US$1,099.95"` as a number;
- `"EUR1.099,95"` as a number;


```{r}
parse_number("US$1,099.95") 
parse_number("EUR1.099,95", locale = locale(grouping_mark = "."))
```





# More on data import

For more details on importing data, 

- study the `vignette("readr")` and `vignette("locales")`;
- study <https://readr.tidyverse.org/> and its examples; 
- read [Chapter 11: Data import](https://r4ds.had.co.nz/data-import.html) and complete its exercises. 

See the R package [Datapasta](https://CRAN.R-project.org/package=datapasta) and its [vignette](https://cran.r-project.org/web/packages/datapasta/vignettes/how-to-datapasta.html) for a clipboard-based solution for cut-and-pasting data into [RStudio](https://www.rstudio.com/). 


# Conclusion

<!-- Table with links: -->

All [ds4psy](http://rpository.com/ds4psy/) essentials so far: 

Nr. | Topic       |
---:|:------------| 
0.  | [Syllabus](http://rpository.com/ds4psy/) | 
1.  | [Basic R concepts and commands](http://rpository.com/ds4psy/essentials/basics.html) | 
2.  | [Visualizing data](http://rpository.com/ds4psy/essentials/visualize.html) | 
3.  | [Transforming data](http://rpository.com/ds4psy/essentials/transform.html) |
4.  | [Exploring data (EDA)](http://rpository.com/ds4psy/essentials/explore.html) | 
5.  | [Tibbles](http://rpository.com/ds4psy/essentials/tibbles.html) |
6.  |  **Importing data** |
+.  | [Datasets](http://rpository.com/ds4psy/essentials/datasets.html) | 


<!--
Nr. | Topic       |
---:|:------------| 
0.  | [Syllabus](http://rpository.com/ds4psy/) | 
1.  | [Basic R concepts and commands](http://rpository.com/ds4psy/essentials/basics.html) | 
2.  | [Visualizing data](http://rpository.com/ds4psy/essentials/visualize.html) | 
3.  | [Transforming data](http://rpository.com/ds4psy/essentials/transform.html) |
4.  | [Exploring data (EDA)](http://rpository.com/ds4psy/essentials/explore.html) | 
5.  | [Tibbles](http://rpository.com/ds4psy/essentials/tibbles.html) |
6.  | [Importing data](http://rpository.com/ds4psy/essentials/import.html) |
7.  | [Tidying data](http://rpository.com/ds4psy/essentials/tidy.html) |
+.  | [Datasets](http://rpository.com/ds4psy/essentials/datasets.html) | 
-->

[Last update on `r Sys.time()` by [hn](http://neth.de/).]  

<!-- eof. --> 