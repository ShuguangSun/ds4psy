---
title: "Iteration, with WPA10 and solutions (ds4psy)"
author: "Hansjörg Neth, SPDS, uni.kn"
date: "2019 04 05"
output:
   rmdformats::html_clean: # html_clean html_docco readthedown material #
     code_folding: show # hide
     toc_float: true
     toc_depth: 3
     highlight: default # textmate default kate haddock monochrome #
     lightbox: true # true by default
     fig_width: 7 # in inches
editor_options: 
  chunk_output_type: console # inline
---

<!-- Example of essential commands | ds4psy: Winter/Spring 2018/2019 -->

```{r preamble, echo = FALSE, eval = TRUE, cache = FALSE, message = FALSE, warning = FALSE}
## (a) Housekeeping: -----
rm(list=ls()) # clean all.

## (b) Current file name and path: ----- 
# my_path <- dirname(rstudioapi::getActiveDocumentContext()$path)
# my_path
# setwd(my_path) # set to current directory
setwd("~/Desktop/stuff/Dropbox/_code/R/_teachR/ds4psy/_essentials") # set to current directory
# list.files() # all files + folders in current directory
fileName <- "iteration.Rmd"

## (c) Packages: ----- 
library(knitr)
library(rmdformats)
library(tidyverse)

## (d) Global options: ----- 
options(max.print = "75")
opts_chunk$set(echo = TRUE,
	             cache = TRUE,
               prompt = FALSE,
               tidy = FALSE,
               collapse = TRUE, # set TRUE in answers 
               comment = "#>",
               message = FALSE,
               warning = FALSE,
               ## Default figure options:
               fig.width = 7, 
               fig.asp = .618, # golden ratio
               out.width = "75%",
               fig.align = "center"
               )
opts_knit$set(width = 75)

## (e) Custom functions: ----- 
source(file = "~/Desktop/stuff/Dropbox/_code/R/_teachR/ds4psy/R/custom_functions.R")
```

# Introduction

This file contains **essential commands** from [Chapter 21: Iteration](https://r4ds.had.co.nz/iteration.html) of the textbook [r4ds](http://r4ds.had.co.nz) and corresponding examples and exercises. 
A command is considered "essential" when you really need to _know_ it and need to know _how to use_ it to succeed in this course. 

<!-- Table with links: -->

All [ds4psy](http://rpository.com/ds4psy/) essentials so far: 

Nr. | Topic       |
---:|:------------| 
0.  | [Syllabus](http://rpository.com/ds4psy/) | 
1.  | [Basic R concepts and commands](http://rpository.com/ds4psy/essentials/basics.html) | 
2.  | [Visualizing data](http://rpository.com/ds4psy/essentials/visualize.html) | 
3.  | [Transforming data](http://rpository.com/ds4psy/essentials/transform.html) |
4.  | [Exploring data (EDA)](http://rpository.com/ds4psy/essentials/explore.html) | 
5.  | [Tibbles](http://rpository.com/ds4psy/essentials/tibbles.html) |
6.  | [Importing data](http://rpository.com/ds4psy/essentials/import.html) |
7.  | [Tidying data](http://rpository.com/ds4psy/essentials/tidy.html) |
8.  | [Joining data](http://rpository.com/ds4psy/essentials/join.html) |
9.  | [Functions](http://rpository.com/ds4psy/essentials/function.html) |
10.  | **Iteration**|
+.  | [Datasets](http://rpository.com/ds4psy/essentials/datasets.html) | 

<!--
Nr. | Topic       |
---:|:------------| 
0.  | [Syllabus](http://rpository.com/ds4psy/) | 
1.  | [Basic R concepts and commands](http://rpository.com/ds4psy/essentials/basics.html) | 
2.  | [Visualizing data](http://rpository.com/ds4psy/essentials/visualize.html) | 
3.  | [Transforming data](http://rpository.com/ds4psy/essentials/transform.html) |
4.  | [Exploring data (EDA)](http://rpository.com/ds4psy/essentials/explore.html) | 
5.  | [Tibbles](http://rpository.com/ds4psy/essentials/tibbles.html) |
6.  | [Importing data](http://rpository.com/ds4psy/essentials/import.html) |
7.  | [Tidying data](http://rpository.com/ds4psy/essentials/tidy.html) |
8.  | [Joining data](http://rpository.com/ds4psy/essentials/join.html) |
9.  | [Functions](http://rpository.com/ds4psy/essentials/function.html) |
10.  | [Iteration](http://rpository.com/ds4psy/essentials/iteration.html) |
+.  | [Datasets](http://rpository.com/ds4psy/essentials/datasets.html) | 
-->

## Course coordinates

<!-- uni.kn logo and link to SPDS: -->  
<!-- ![](./inst/pix/uniKn_logo.png) --> 
<a href="https://www.spds.uni-konstanz.de/">
<img src = "../inst/pix/uniKn_logo.png" alt = "spds.uni.kn" align = "right" width = "300" style = "width: 300px; float: right; border:20;"/>
<!-- <img src = "./inst/pix/uniKn_logo_s.png" alt = "spds.uni.kn" style = "float: right; border:20;"/> --> 
</a>

* Taught at the [University of Konstanz](https://www.uni-konstanz.de/) by [Hansjörg Neth](http://neth.de/) (<h.neth@uni.kn>,  [SPDS](https://www.spds.uni-konstanz.de/), office D507).
* Winter 2018/2019: Mondays, 13:30--15:00, C511. 
* Links to current [course syllabus](http://rpository.com/ds4psy/) | [ZeUS](https://zeus.uni-konstanz.de/hioserver/pages/startFlow.xhtml?_flowId=detailView-flow&unitId=5101&periodId=78&navigationPosition=hisinoneLehrorganisation,examEventOverviewOwn) |  [Ilias](https://ilias.uni-konstanz.de/ilias/goto_ilias_uni_crs_809936.html) 


## Preparations

Create an R script (`.R`) or an R-Markdown file (`.Rmd`) and load the R packages of the `tidyverse`. (**Hint:** Structure your script by inserting spaces, meaningful comments, and sections.) 

```{r layout_template, echo = TRUE, eval = FALSE}
## Iteration | ds4psy
## 2019 01 31
## ----------------------------

## Preparations: ----------

library(tidyverse)

## 1. Topic: ----------

# etc.

## End of file (eof). ----------  
```

To use [R Markdown](https://rmarkdown.rstudio.com), create a corresponding file and save it with the `.Rmd` extension (e.g., by selecting `File > New File > R Markdown`). 
For instructions on combining text and code, see [Chapter 27: R Markdown](https://r4ds.had.co.nz/r-markdown.html) of our textbook, or use one of the following templates:  

- minimal template:  `rmd_template_s` [in [.Rmd](http://rpository.com/down/temp/rmd_template_s.Rmd) | [.html](http://rpository.com/down/temp/rmd_template_s.html) format]

- medium template: `rmd_template_m` [in [.Rmd](http://rpository.com/down/temp/rmd_template_m.Rmd) | [.html](http://rpository.com/down/temp/rmd_template_m.html) format]

- explicit explanations: `Rmarkdown_basics` [in [.Rmd](http://rpository.com/down/temp/Rmarkdown_basics.Rmd) | [.html](http://rpository.com/down/temp/Rmarkdown_basics.html) format]

**Hint:** Try to _knit_ your `.Rmd` file immediately after saving it and marvel at the beauty of the resulting `.html`-file. If this works, keep doing this routinely from now on, putting all your R-code into code chunks, and any text (like headings or conclusions) that describes or explains what you are doing outside of them. From now on, you can share your `.html` output files, rather than your `.Rmd` source files when showing off your R and data science skills.

# Iteration

Iteration := doing things repeatedly.

## Loops

```{r create_data_tb, echo = FALSE, eval = TRUE}
# Create data with numeric columns:
set.seed(100)
N <- 100

id <- 1:N

age <- round(rnorm(N, 25, 8), 0)
age[age < 18] <- (age[age < 18] + 8)

height <- round(rnorm(N, 178, 15), 0)
height[height < 148] <- (height[height < 148] + 4)
height[height > 195] <- (height[height > 195] - 5)

shoesize <- round(rnorm(N, 38, 4), 0)
shoesize[shoesize < 32] <- (shoesize[shoesize < 32] + 2)
shoesize[shoesize < 34] <- (shoesize[shoesize < 34] + 1)
shoesize[shoesize > 42] <- (shoesize[shoesize > 43] - 1)
shoesize[shoesize > 45] <- (shoesize[shoesize > 46] - 2)

# Correlation: shoesize & height: 
shoesize[height < 157] <- (shoesize[height < 157] - 3)
shoesize[height < 164] <- (shoesize[height < 164] - 2)
shoesize[height < 171] <- (shoesize[height < 171] - 1)
shoesize[height > 198] <- (shoesize[height > 198] + 4)
shoesize[height > 192] <- (shoesize[height > 192] + 3)
shoesize[height > 185] <- (shoesize[height > 185] + 2)
shoesize[height > 179] <- (shoesize[height > 179] + 1)

IQ <- round(rnorm(N, 105, 12), 0)
IQ[IQ < 81] <- (IQ[IQ < 81] + 6)
IQ[IQ < 85] <- (IQ[IQ < 85] + 4)
IQ[IQ < 92] <- (IQ[IQ < 92] + 2)

# Tibble:
tb <- tibble(id, age, height, shoesize, IQ)
head(tb)

## Correlation: shoesize ~ height: 
# plot(tb$shoesize ~ tb$height)
# abline(lm(shoesize ~ height, tb), col = "red")

## Correlation: IQ ~ height: 
# plot(tb$IQ ~ tb$height)
# abline(lm(IQ ~ height, tb), col = "green3")

## Write out table:
# write_csv2(tb, path = "../data/tb.csv")

## Read in table again:
# read_csv2("../data/tb.csv")
```

### Using a `for` loop

Asking and answering 3 questions:

1. _body_: What is the task performed in the loop?

2. _sequence_: Over which sequence should be iterated? _How many_ iterations are there?

3. _output_: What is the _result_ of the loop: What _type_ of object and _how many_ instances? 

After answering these questions, a loop can be designed in reverse order (from output to body):

```{r for_loop_template, echo = TRUE, eval = FALSE}
# (a) prepare output: 
output <- vector(<type>, length(start:end))  

# (b) for loop: 
for (i in start:end} {                    # sequence
  
  result_i <- <solve task for i-th case>  # body: solve task
  output[[i]] <- result_i                 #       collect results in output

}

# (c) use output: 
output  
```

#### Loops for iteration

Assuming we know how often we want to do something. 

Example: Compute square number of integers from 1 to 10.

1. _body_: Square of some number `i`.
2. _sequence_: `i` from 1 to 10.
3. _output_: A vector of 10 numbers.

Implementation:

```{r}
# (a) prepare output: 
output <- vector("double", length(1:10))

# (b) for loop: 
for (i in 1:10) {
  
  sq <- i^2
  print(paste0("i = ", i, ": sq = ", sq))  # for debugging
  output[[i]] <- sq
  
}

# (c) use output: 
output  
```

**Note:** In the loop, we use `output[[i]]`, rather than `output[i]` to refer to the `i`-th element of `output` . 
Actually, using a single `[]` would have worked as well, but the double `[[]]` makes it clear that we want to remove a level of the hierarchy and 
assign something to a single element of `output`. (See [Ch. 20.5.2 Subsetting recursive vectors (lists)](https://r4ds.had.co.nz/vectors.html#subsetting-1) for more details on this distinction.) 


#### Loops over data

In the context of data science, we typically want to iterate over (rows or columns) of data tables. 

Load some data:

```{r}
## Load data:
# tb <- read_csv2("../data/tb.csv")  # from local file
tb <- read_csv2("http://rpository.com/ds4psy/data/tb.csv")  # from local file
```

A repeated operation for each variable (column) on a table:

```{r}
# (a) Means: ---- 
mean(tb$age)
mean(tb$height)
mean(tb$shoesize)
mean(tb$IQ)
```

Repetition is a signal that there are more efficient ways.

How could we use a loop? To design the loop, we need to answer our 3 questions: 

1. _body_: Compute the mean of 4 columns (`age` to `IQ`) in `tb`.

2. _sequence_: We want to iterate over columns 2 to 5 (4 iterations).

3. _output_: The _result_ is a vector of type "double" with 4 instances. 

Note: 

- We remove the 1st column, as no computation is needed for it.

- The i-th column of tibble `tb` (or data frame `df`) can be accessed via `tb[[i]]` (or `df[[i]]`). 

```{r}
# Prepare data: 
tb_2 <- tb %>% select(-1)
tb_2

# (a) prepare output: 
output <- vector("double", 4)

# (b) for loop: 
for (i in 1:4){
  
  mn <- mean(tb_2[[i]])
  
  output[[i]] <- mn
  
}

# (c) use output: 
output
```

In the `tidyverse` the loop range can be defined with a special function: 

```{r}
seq_along(tb_2)
```

#### Practice

Note that loop requires knowing (a) the data type of the loop results and (b) a data structure than can collect these results. 
This is simple and straightforward if each loop results in a single number, as then all results can be stored in a vector. 

However, things get more complicated if loops yield tables, lists, or plots. 

Repeat loops for `summary` and for `hist` of each variable in `tb` (or rather `tb_2`): 

Summary: 

```{r}
# (b) Summary: ---- 
summary(tb$age)
summary(tb$height)
summary(tb$shoesize)
s <- summary(tb$IQ)
s

# What type of object is s?
typeof(s)     # "double"
is.vector(s)  # FALSE
is.table(s)   # TRUE
```

Histogram: 

```{r}
# (c) Histogram: ---- 
hist(tb$age)
hist(tb$height)
hist(tb$shoesize)
h <- hist(tb$IQ)
h

typeof(h) # list

# As loop: 
tb_2
names(tb_2[1])
hist(tb_2[[1]], main = paste0("Histogram of ", names(tb_2[1]), " values:"), xlab = names(tb_2[1]))

# With loop:
out <- vector("list", 4)

for (i in seq_along(tb_2)) {
  print(i)
  var_name <- names(tb_2[i])
  title <- paste0("Histogram of ", var_name, " values:")
  x_lab <- var_name
  out[[i]] <- hist(tb_2[[i]], main = title, xlab = x_lab)
}

plot(out[[1]])
```


### Variations

4 variations on the basic theme of the for loop:

#### 1. Modifying an existing object, instead of creating a new object.

Example: Rescale every column of a table (tibble or data frame).

```{r}
set.seed(1)  # for reproducible results

tb <- tibble(
  a = rnorm(10),
  b = rnorm(10),
  c = rnorm(10),
  d = rnorm(10)
)
tb

# Define rescale01 function:
rescale01 <- function(x) {
  rng <- range(x, na.rm = TRUE)
  (x - rng[1]) / (rng[2] - rng[1])
}
```

(a) In 4 separate steps:

```{r}
df <- tb  # copy

# (a) each column individually:
df$a <- rescale01(df$a)
df$b <- rescale01(df$b)
df$c <- rescale01(df$c)
df$d <- rescale01(df$d)

df
```

(b) Using a loop to modify an existing object:  

Answers to our 3 questions:

1. _body_: apply `rescale01()` to every column of `tb`.

2. _sequence_: A list of columns (i.e., iterate over each column with `seq_along(tb)`).

3. _output_: `tb` (i.e., identical to the input).

```{r}
# (b) loop that modifies an existing object:
df2 <- tb  # copy

for (i in seq_along(df2)) {
  df2[[i]] <- rescale01(df2[[i]])
}

# Output: 
df2

# Verify equality:
all.equal(df, df2)
```

#### 2. Looping over names or values, instead of indices

So far, we used `for loop` to loop over _numeric indices_ of `x` with `for (i in seq_along(x))`, 
and then extracted the `i`-th value of `x` with `x[[i]]`. 

There are 2 additional common loop patterns:

1. loop over the _elements_ of `x` with `for (x in xs)`: 
useful when only caring about side effects 

2. loop over the _names_ of `x` with `for (nm in names(xs))`: 
useful when names are needed for files or plots.

Whenever creating named output, make sure also provide names to the results vector:

```{r}
x <- 1:3

results <- vector("list", length(x))
names(results) <- names(x)

results
```

Note that the basic iteration over the numeric indices is the most general form, 
because given a position we can extract both the current name and the current value:

```{r}
x <- 1:3
for (i in seq_along(x)) {
  name  <- names(x)[[i]]
  value <- x[[i]]
}
```

#### 3. Handling outputs of unknown length 

- Problem: Not knowing how long the output will be. 

For example, imagine we want to simulate some random vectors of random lengths. 

ToDo: [etc.]

#### 4. Handling sequences of unknown length

- Problem: The number of iterations is not known in advance.
- Solution: `while` loop, with a `condition` to stop loop. 

Sometimes we don’t even know how long the input sequence should run for. 
This is common when doing _simulations_. 
For example, we might want to loop until we get three heads in a row. 
We can’t do that sort of iteration with the `for` loop, but can use a `while` loop instead. 

A `while` loop is simpler than `for` loop because it only has 2 components, a condition and a body:

```{r while_loop_structure, eval = FALSE}
while (condition) {
  # body
}
```


## Functional programming

### For loops vs. functionals

In R, `for` loops are not as important as in other languages, because R is a _functional_ programming language. 
This means that it’s possible to replace `for` loops by wrapping up the `for` loop in a function, and call that function.

#### Example 

Consider a simple data table `df`: 

```{r}
# Data:
df <- tibble(a = rnorm(10),
             b = rnorm(10),
             c = rnorm(10),
             d = rnorm(10)
)
df
```

Assume that our goal is getting the mean of every column. 
The standard solution is using a `for` loop:

```{r}
# loop:
output <- vector("double", length(df))

# for loop over columns i: 
for (i in seq_along(df)) {
  
  output[[i]] <- mean(df[[i]])

}

output
```

As we will want to compute the means of every column pretty frequently, we extract it into a function:

```{r}
col_mean <- function(data) {
  
  output <- vector("double", length(data))
  
  for (i in seq_along(data)) {
    
    output[i] <- mean(data[[i]])  # apply function to i-th column of df
    
  }
  
  output
}

# Check: 
col_mean(df)
```

But now we also want the _median_ and _standard deviation_ of every column. 
Of course we could write analog functions `col_median()` and `col_sd()`, 
but they would only differ in 1 lines from `col_mean` above. 

#### Motivation: Generalising functions

What would we do if we saw a set of functions like this:

```{r}
f1 <- function(x) abs(x - mean(x)) ^ 1
f2 <- function(x) abs(x - mean(x)) ^ 2
f3 <- function(x) abs(x - mean(x)) ^ 3
```

Hopefully, we’d notice that there’s a lot of duplication, 
and extract it into an additional argument to a more general function:

```{r}
f <- function(x, i) abs(x - mean(x)) ^ i
```

By doing this, we’ve reduced the chance of bugs (because you now have 1/3 of the original code), 
and made it easier to generalise to new situations.

#### Application: Using functions as arguments to functions

We can do exactly the same thing with `col_mean()`, `col_median()`, and `col_sd()` 
by adding an argument that supplies the _function_ to apply to each column:

```{r}
col_summary <- function(data, fun) {
  
  out <- vector("double", length(data))
  
  for (i in seq_along(data)) {
    
    out[i] <- fun(data[[i]])  # !!!
    
  }
  
  out

  }

# Repeat use of col_mean (from above): 
col_summary(df, fun = mean) # Note: same functionality/results as above.

# New uses: 
col_summary(df, fun = median)
col_summary(df, fun = sd)
```

The idea of passing a _function_ as an _argument_ to another _function_ is extremely powerful idea, 
and it’s one of the behaviors that makes R a _functional programming language_.

#### `purrr` vs. `apply` 

The `purrr` package provides functions that eliminate the need for many common for loops. 

The `base::apply` family of functions in (i.e., `apply`, `lapply`, `tapply`, etc.) 
solve a similar problem, but `purrr` is more consistent and easier to learn.

#### Using `apply`

Using `base::apply` to solve the above:

- `X` argument takes an array or matrix (i.e., data);
- `MARGIN` argument: `1` = rows, `2` = columns;
- `FUN` is the function to be applied. 

```{r apply}
dim(df)  # 10 rows, 4 columns:

# apply FUN to columns:
apply(X = df, MARGIN = 2, FUN = mean)    # mean of every column
apply(X = df, MARGIN = 2, FUN = median)  # median of every column
apply(X = df, MARGIN = 2, FUN = sd)      # SD of every column

# apply FUN to rows:
apply(X = df, MARGIN = 1, FUN = mean)    # mean of every row
apply(X = df, MARGIN = 1, FUN = median)  # median of every row
apply(X = df, MARGIN = 1, FUN = sd)      # SD of every row
```

Note: 

- `lapply` returns a _list_ of the same length as `X`, each element of which is the result of applying `FUN` to the corresponding element of `X`.

- See also `sapply` and `vapply` for simplifying arrays and returning vectors. 

<!-- +++ here now +++ --> 



# Exercises (WPA10)

Here are the exercises of WPA10 and possible solutions for them.


## Exercise X

Iteration only:

- `z`-transform every numeric column of a table

Loops in new functions

- Write a function that z-transforms every numeric column in a table. 


# More on iteration

- For loops in general, see the [contributed cheatsheets](https://www.rstudio.com/resources/cheatsheets/) on _Base R_ and _Advanced R_. 

- For references on functional programming (FP) with `purrr`, see <https://purrr.tidyverse.org> and the [purrr cheatsheet](https://www.rstudio.com/resources/cheatsheets/). 

- See [Chapter 21: Iteration](https://r4ds.had.co.nz/iteration.html) of [r4ds](https://r4ds.had.co.nz/) and its exercises. 


# Conclusion

<!-- Table with links: -->

All [ds4psy](http://rpository.com/ds4psy/) essentials so far: 

Nr. | Topic       |
---:|:------------| 
0.  | [Syllabus](http://rpository.com/ds4psy/) | 
1.  | [Basic R concepts and commands](http://rpository.com/ds4psy/essentials/basics.html) | 
2.  | [Visualizing data](http://rpository.com/ds4psy/essentials/visualize.html) | 
3.  | [Transforming data](http://rpository.com/ds4psy/essentials/transform.html) |
4.  | [Exploring data (EDA)](http://rpository.com/ds4psy/essentials/explore.html) | 
5.  | [Tibbles](http://rpository.com/ds4psy/essentials/tibbles.html) |
6.  | [Importing data](http://rpository.com/ds4psy/essentials/import.html) |
7.  | [Tidying data](http://rpository.com/ds4psy/essentials/tidy.html) |
8.  | [Joining data](http://rpository.com/ds4psy/essentials/join.html) |
9.  | [Functions](http://rpository.com/ds4psy/essentials/function.html) |
10.  | **Iteration**|
+.  | [Datasets](http://rpository.com/ds4psy/essentials/datasets.html) | 

<!--
Nr. | Topic       |
---:|:------------| 
0.  | [Syllabus](http://rpository.com/ds4psy/) | 
1.  | [Basic R concepts and commands](http://rpository.com/ds4psy/essentials/basics.html) | 
2.  | [Visualizing data](http://rpository.com/ds4psy/essentials/visualize.html) | 
3.  | [Transforming data](http://rpository.com/ds4psy/essentials/transform.html) |
4.  | [Exploring data (EDA)](http://rpository.com/ds4psy/essentials/explore.html) | 
5.  | [Tibbles](http://rpository.com/ds4psy/essentials/tibbles.html) |
6.  | [Importing data](http://rpository.com/ds4psy/essentials/import.html) |
7.  | [Tidying data](http://rpository.com/ds4psy/essentials/tidy.html) |
8.  | [Joining data](http://rpository.com/ds4psy/essentials/join.html) |
9.  | [Functions](http://rpository.com/ds4psy/essentials/function.html) |
10. | [Iteration](http://rpository.com/ds4psy/essentials/iteration.html) |
+.  | [Datasets](http://rpository.com/ds4psy/essentials/datasets.html) | 
-->

[Last update on `r Sys.time()` by [hn](http://neth.de/).]  

<!-- eof. --> 