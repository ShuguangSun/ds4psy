---
title: "Joining data, with solutions (ds4psy)"
author: "Hansjörg Neth, SPDS, uni.kn"
date: "2019 01 20"
output:
   rmdformats::html_clean: # html_clean html_docco readthedown material #
     code_folding: show # hide
     toc_float: true
     toc_depth: 3
     highlight: default # textmate default kate haddock monochrome #
     lightbox: true # true by default
     fig_width: 7 # in inches
editor_options: 
  chunk_output_type: console # inline
---

<!-- Example of essential commands | ds4psy: Winter/Spring 2018/2019 -->

```{r preamble, echo = FALSE, eval = TRUE, cache = FALSE, message = FALSE, warning = FALSE}
## (a) Housekeeping: -----
rm(list=ls()) # clean all.

## (b) Current file name and path: ----- 
# my_path <- dirname(rstudioapi::getActiveDocumentContext()$path)
# my_path
# setwd(my_path) # set to current directory
setwd("~/Desktop/stuff/Dropbox/_code/R/_teachR/ds4psy/_essentials") # set to current directory
# list.files() # all files + folders in current directory
fileName <- "join.Rmd"

## (c) Packages: ----- 
library(knitr)
library(rmdformats)
library(tidyverse)

## (d) Global options: ----- 
options(max.print = "75")
opts_chunk$set(echo = TRUE,
	             cache = TRUE,
               prompt = FALSE,
               tidy = FALSE,
               collapse = TRUE, # set TRUE in answers 
               comment = "#>",
               message = FALSE,
               warning = FALSE,
               ## Default figure options:
               fig.width = 7, 
               fig.asp = .618, # golden ratio
               out.width = "75%",
               fig.align = "center"
               )
opts_knit$set(width = 75)

## (e) Custom functions: ----- 
source(file = "~/Desktop/stuff/Dropbox/_code/R/_teachR/ds4psy/R/custom_functions.R")
```

# Introduction

This file contains **essential commands** from [Chapter 13: Relational data](https://r4ds.had.co.nz/relational-data.html) of the textbook [r4ds](http://r4ds.had.co.nz) and corresponding examples and exercises. 
A command is considered "essential" when you really need to _know_ it and need to know _how to use_ it to succeed in this course. 

<!-- Table with links: -->

All [ds4psy](http://rpository.com/ds4psy/) essentials so far: 

Nr. | Topic       |
---:|:------------| 
0.  | [Syllabus](http://rpository.com/ds4psy/) | 
1.  | [Basic R concepts and commands](http://rpository.com/ds4psy/essentials/basics.html) | 
2.  | [Visualizing data](http://rpository.com/ds4psy/essentials/visualize.html) | 
3.  | [Transforming data](http://rpository.com/ds4psy/essentials/transform.html) |
4.  | [Exploring data (EDA)](http://rpository.com/ds4psy/essentials/explore.html) | 
5.  | [Tibbles](http://rpository.com/ds4psy/essentials/tibbles.html) |
6.  | [Importing data](http://rpository.com/ds4psy/essentials/import.html) |
7.  | [Tidying data](http://rpository.com/ds4psy/essentials/tidy.html) |
8.  | **Joining data** |
+.  | [Datasets](http://rpository.com/ds4psy/essentials/datasets.html) | 

<!--
Nr. | Topic       |
---:|:------------| 
0.  | [Syllabus](http://rpository.com/ds4psy/) | 
1.  | [Basic R concepts and commands](http://rpository.com/ds4psy/essentials/basics.html) | 
2.  | [Visualizing data](http://rpository.com/ds4psy/essentials/visualize.html) | 
3.  | [Transforming data](http://rpository.com/ds4psy/essentials/transform.html) |
4.  | [Exploring data (EDA)](http://rpository.com/ds4psy/essentials/explore.html) | 
5.  | [Tibbles](http://rpository.com/ds4psy/essentials/tibbles.html) |
6.  | [Importing data](http://rpository.com/ds4psy/essentials/import.html) |
7.  | [Tidying data](http://rpository.com/ds4psy/essentials/tidy.html) |
8.  | [Joining data](http://rpository.com/ds4psy/essentials/join.html) |
+.  | [Datasets](http://rpository.com/ds4psy/essentials/datasets.html) | 
-->

## Course coordinates

<!-- uni.kn logo and link to SPDS: -->  
<!-- ![](./inst/pix/uniKn_logo.png) --> 
<a href="https://www.spds.uni-konstanz.de/">
<img src = "../inst/pix/uniKn_logo.png" alt = "spds.uni.kn" align = "right" width = "300" style = "width: 300px; float: right; border:20;"/>
<!-- <img src = "./inst/pix/uniKn_logo_s.png" alt = "spds.uni.kn" style = "float: right; border:20;"/> --> 
</a>

* Taught at the [University of Konstanz](https://www.uni-konstanz.de/) by [Hansjörg Neth](http://neth.de/) (<h.neth@uni.kn>,  [SPDS](https://www.spds.uni-konstanz.de/), office D507).
* Winter 2018/2019: Mondays, 13:30--15:00, C511. 
* Links to current [course syllabus](http://rpository.com/ds4psy/) | [ZeUS](https://zeus.uni-konstanz.de/hioserver/pages/startFlow.xhtml?_flowId=detailView-flow&unitId=5101&periodId=78&navigationPosition=hisinoneLehrorganisation,examEventOverviewOwn) |  [Ilias](https://ilias.uni-konstanz.de/ilias/goto_ilias_uni_crs_809936.html) 


## Preparations

Create an R script (`.R`) or an R-Markdown file (`.Rmd`) and load the R packages of the `tidyverse`. (**Hint:** Structure your script by inserting spaces, meaningful comments, and sections.) 

```{r layout_template, echo = TRUE, eval = FALSE}
## Joining data | ds4psy
## 2019 01 21
## ----------------------------

## Preparations: ----------

library(tidyverse)

## 1. Topic: ----------

# etc.

## End of file (eof). ----------  
```

To use [R Markdown](https://rmarkdown.rstudio.com), create a corresponding file and save it with the `.Rmd` extension (e.g., by selecting `File > New File > R Markdown`). 
For instructions on combining text and code, see [Chapter 27: R Markdown](https://r4ds.had.co.nz/r-markdown.html) of our textbook, or use one of the following templates:  

- minimal template:  `rmd_template_s` [in [.Rmd](http://rpository.com/down/temp/rmd_template_s.Rmd) | [.html](http://rpository.com/down/temp/rmd_template_s.html) format]

- medium template: `rmd_template_m` [in [.Rmd](http://rpository.com/down/temp/rmd_template_m.Rmd) | [.html](http://rpository.com/down/temp/rmd_template_m.html) format]

- explicit explanations: `Rmarkdown_basics` [in [.Rmd](http://rpository.com/down/temp/Rmarkdown_basics.Rmd) | [.html](http://rpository.com/down/temp/Rmarkdown_basics.html) format]

**Hint:** Try to _knit_ your `.Rmd` file immediately after saving it and marvel at the beauty of the resulting `.html`-file. If this works, keep doing this routinely from now on, putting all your R-code into code chunks, and any text (like headings or conclusions) that describes or explains what you are doing outside of them. From now on, you can share your `.html` output files, rather than your `.Rmd` source files when showing off your R and data science skills.


# Joining data

All the data we considered so far appeared in the form of a single table (or multiple versions of the same table, some of which needed [transforming](http://rpository.com/ds4psy/essentials/transform.html) and [tidying](http://rpository.com/ds4psy/essentials/tidy.html) etc.). 
In reality, however, many datasets are distributed over multiple tables. To analyze such data, an important first step is to combine those tables without messing up their contents. To combine data from multiple tables, we need to specify how they are related (which is why this chapter is called "relational data"). A _relation_ between tables typically is a variable that occurs in both tables: Provided that this variable has the same meaning in both tables, it is called a _key_ (see [Chapter 13.3](https://r4ds.had.co.nz/relational-data.html#keys) for details) and allows linking the observations (rows) from one table to those of the other one. 

Joining 2 tables is simple and straightforward when variables have common variables (names and types) and both tables describe the same cases (rows). However, it's clear that we may encounter problems in which one table uses different names or types than the other one and that both tables can differ in the number of cases they contain (e.g., one may contain a sub-set of cases of the other one, or both contain some common but also some unique cases). In these instances, it's absolutely crucial that we first understand each table by itself (its dimensions, cases and variables, contents) and their relation to each other (e.g., which cases and variables occur in both tables) before trying to join them.[^1] 

[^1]: For this reason, most real-world joins are preceded by sequences of `select`, `mutate`, and `arrange` commands on one or both tables.

### Terminology 

The verb "join" and the term "relational data" comes from relational databases (see [in Wikipedia](https://en.wikipedia.org/wiki/Join_(SQL)) and relational algebra (see [in Wikipedia](https://en.wikipedia.org/wiki/Relational_algebra)). 

### Base R vs. tidyverse commands

When we are ready to join tables, base R offers basic `base::rbind` and `base::cbind` commands (to bind rows or columns of data), but these are intended for tables with identical variables or cases, respectively. Joining 2 data frames can be achieved by using `base::merge` (see below). 

Alternatively, the `tidyverse` package `dplyr` (whose so-called 1-table verbs we have used for data [transformation](http://rpository.com/ds4psy/essentials/transform.html)) contains additional _2-table verbs_ 
that allow joining 2 tables of data with 3 different types of commands: 

1. _Mutating joins_ add new _variables_ (columns) to one table from matching cases (rows) of another table. 

2. _Filtering joins_ filter _observations_ (rows) from one table based on whether or not they match a case (row) in another table. 

3. _Set operations_ combine the observations in two tables as if they were set elements. 

In the following, we will briefly describe the essential commands for each type of join. 
(See [Chapter 13: Relational data](https://r4ds.had.co.nz/relational-data.html) and the `vignette("two-table")` for additional details.)


## Mutating joins

The term _mutating_ is used in analogy to the `dplyr::mutate` command: Just as `mutate` creates new variables (columns), 
a mutating join adds new variables (columns) to a table from matching cases (rows) of another table. 

### Commands

There are 4 types of mutating joins to combine the columns of tables `x` and `y`: 

1. `left_join(x, y)`: Return all rows from `x`, and all columns from `x` and `y`. 
Rows in `x` with no match in `y` will have `NA` values in the new columns. 
If there are multiple matches between `x` and `y`, all combinations of the matches are returned.

2. `right_join(x, y)`: Same as `left_join(y, x)`, and hence not necessary. 

3. `full_join(x, y): Return all rows and all columns that exist in `x` and `y` together. 
If there are non-matching values, return `NA` for the one missing. 

4. `inner_join(x, y)`: Return all rows from `x` where there are matching values in `y`, and all columns from `x` and `y`. 
If there are multiple matches between `x` and `y`, all combination of the matches are returned.

Beyond specifying the 2 tables to join, all commands take a `by` argument:

- `by` specifies a character vector of variables by which we want to join the tables. 

- If `by = NULL` (as by default) `*_join` will perform a _natural_ join, using _all variables with common names_ across the 2 tables. A message lists the variables used, so that we can verify that this is what we wanted. 

- To join by differently named variables on `x` and `y`, we can provide a named vector. For instance, `by = c("a" = "b")` will match variable `a` in table `x` to variable `b` in table `y`.

### Examples

To test these commands, we load the following data files:

- [data_t1](http://rpository.com/ds4psy/data/data_t1.csv)
- [data_t2](http://rpository.com/ds4psy/data/data_t2.csv)

```{r load_t1_t2}
# Load data:
data_t1 <- read_csv(file = "http://rpository.com/ds4psy/data/data_t1.csv")
data_t2 <- read_csv(file = "http://rpository.com/ds4psy/data/data_t2.csv")

# Copy data:
t1 <- data_t1
t2 <- data_t2

# Inspect data:
t1
t2
```

Note that `t1` and `t2` are both 20 x 4 tibbles and appear to contain the responses or test scores of people. 
This suggests that they may be 2 measurements of the same people. However, before jumping into joining the tables, we should check whether they really contain the same people:

```{r check_t1_t2}
# Do both tables contain common variables?
sum(names(t1) %in% names(t2))        # Number of common variables: 
names(t1)[names(t1) %in% names(t2)]  # Names of common variables: 

# Arrange the rows of tables by common variables:
t1 <- t1 %>% arrange(name, gender) 
t2 <- t2 %>% arrange(name, gender)

# Are they equal in both tables?
all.equal(t1$name, t2$name)
all.equal(t1$gender, t2$gender)
```

This confirms our intuition: `t1` and `t2` contain 2 variables of demographic information (`name` and `gender`) of 20 people and each table contains 2 additional variables (measurements or test scores). Under _these_ conditions, the 4 join commands all yield the same result:

```{r mutating_joins_1}
# 1. left_join:
m1 <- left_join(t1, t2)
m1

# 2. right_join:
m2 <- right_join(t1, t2)
m2

# 3. full_join:
m3 <- full_join(t1, t2)
m3

# 4. inner_join:
m4 <- inner_join(t1, t2)
m4

# Verify equality:
all.equal(m1, m2)
all.equal(m1, m3)
all.equal(m1, m4)
```

Note that the join commands automatically used the 2 common variables as `key` variables to join the tables (i.e., used 
`by = c("name", "gender")`). This raises the question: What would happen if we only specified one of them? Let's check:

```{r mutating_joins_duplicate_vars}
left_join(t1, t2, by = "name")   # => 2 gender columns, distinguished by suffixes .x and .y
left_join(t1, t2, by = "gender") # => 2 name columns, distinguished by suffixes .x and .y

# To control the suffix:
left_join(t1, t2, by = "name", suffix = c("_1", "_2"))
```

We see that common variables _not_ used for joining the tables get duplicated in the joint table and distinguished by a unique suffix. 

To see and appreciate the differences between the 4 mutating joins, we need tables that contain different and repeated cases. 
We can easily create these by selecting and duplicating some cases in each of our tables:[^2]

[^2]: It's not crucial to understand the following code. It only serves to select some random cases from each table and create some duplicate cases in each.

```{r sample_and_copy_cases}
# Copy data (again): ------ 
t3 <- data_t1
t4 <- data_t2

# Modify both tables: ------ 
# (a) Draw n random rows (samples):
set.seed(12)  # for replicability
n <- 8
s1 <- sample(1:nrow(t3), size = n, replace = FALSE)  # n random values from 1 to nrow(t3)
s2 <- sample(1:nrow(t4), size = n, replace = FALSE)  # n random values from 1 to nrow(t4)

# Reduce rows and arrange both tables:
t3 <- t3[s1, ]
t4 <- t4[s2, ]

# (b) Duplicate m random rows:
set.seed(23)  # for replicability
m <- 2
d1 <- sample(1:nrow(t3), size = m, replace = FALSE)  # n random values from 1 to nrow(t3)
d2 <- sample(1:nrow(t4), size = m, replace = FALSE)  # n random values from 1 to nrow(t4)

# Duplicate sampled rows:
t3 <- rbind(t3, t3[d1, ])
t4 <- rbind(t4, t4[d2, ])

# Arrange tables:
t3 <- t3 %>% arrange(name, gender)
t4 <- t4 %>% arrange(name, gender)
```

The resulting tables `t3` and `t4` are both 10 x 4 tibbles and contain some common and some unique cases (people). 
In addition, each table contains 2 people twice: 

```{r}
# Inspect resulting tables: ------ 
t3
t4

# Common cases:
t3$name[t3$name %in% t4$name]  # people in t3 that also appear in t4
t4$name[t4$name %in% t3$name]  # people in t4 that also appear in t3

# Unique cases:
t3$name[!t3$name %in% t4$name] # people in t3 that are NOT in t4
t4$name[!t4$name %in% t3$name] # people in t4 that are NOT in t3
```

Now let's re-do the 4 mutating joins with `t3` and `t4` and inspect the resulting tables:

```{r mutating_joins_2}
# 1. left_join:
m5 <- left_join(t3, t4)
m5  # => 12 x 6 table, containing all cases of t3, plus additional cases for duplicate cases.

# +++ here now +++

# 2. right_join:
m6 <- right_join(t3, t4)
m6  # => 12 x 6 table, containing all cases of t4, plus additional cases for duplicate cases.

all.equal(m5, m6)  # shows differences, but 
all.equal(m5, right_join(t4, t3)) # is TRUE

# 3. full_join:
m7 <- full_join(t3, t4)
m7  # => 17 x 6 table

# 4. inner_join:
m8 <- inner_join(t3, t4)
m8  # => 7 x 6 table 
```







## Filtering joins

## Set operations


## Using `merge`

The base R command `merge`


# Exercises (WPA08)

Here are the exercises of WPA08 and possible solutions for them.


## Exercise 1

This exercise uses the following data files:

- [data_t3](http://rpository.com/ds4psy/data/data_t3.csv)
- [data_t4](http://rpository.com/ds4psy/data/data_t4.csv)

1. Import both tables of data (as `data_t3` and `data_t4`) and check out each table individually, before comparing them to each other. 
Do both tables contain the same cases and variables?

```{r ex1_1}
# Load data: 
data_t3 <- read_csv(file = "http://rpository.com/ds4psy/data/data_t3.csv")
data_t4 <- read_csv(file = "http://rpository.com/ds4psy/data/data_t4.csv")

# Inspect tables:
data_t3  # 20 x 4
data_t4  # 20 x 4

# Both tables seem similar, but do not share variable names.
# Are names and initials identical?

# Arrange both tables by first 2 variables:
data_t3 <- data_t3 %>% arrange(name, gender)
data_t4 <- data_t4 %>% arrange(initials, sex)

all.equal(data_t3$name, data_t4$initials)  # TRUE
all.equal(data_t3$gender, data_t4$sex)     # TRUE
# => Both tables seem to contain the same people as cases!
```

2. Join both tables by using only the `name` variable of `data_t3` and `initials` variable of `data_t4`. 
Why is this difficult or impossible? 

```{r ex1_2}
# Copy data: Make sure that cases are arranged in the same way:
t3 <- data_t3 %>% arrange(name, gender)
t4 <- data_t4 %>% arrange(initials, sex)

# Note 1:
# left_join(t3, t4)  # would yield an error:
# `by` required, because the data sources have no common variables

# Let's specify both primary and foreign key as:  
# by = c("name" = "initials")

# Note 2: Both of the following 
left_join(t3, t4, by = c("name" = "initials"))
full_join(t3, t4, by = c("name" = "initials"))
# yield 22 x 7 tables.

# Problem: The name/initials "A.V." appears TWICE data_t3 and data_t4:
length(unique(data_t3$name))            # => only 19 unique names
data_t3$name[duplicated(data_t3$name)]  # => "A.V." appears twice.
# ==> The combination lists 2x2 instances of "A.V.". 
```

3. Join both tables into a 20 x 6 table that contains all data in 1 table.

The following solution first re-names 2 variables in one table (to have 2 matching key variables): 

```{r ex1_3a}
# Copy data: Make sure that cases are arranged in the same way:
t3 <- data_t3 %>% arrange(name, gender)
t4 <- data_t4 %>% arrange(initials, sex)

# Solution 1:
# (a) Rename both key variables in one table:
names(t4)[1:2] <- names(t3)[c(1, 2)] 

# (b) Join both tables using both key variables:
left_join(t3, t4, by = c("name", "gender")) # => 20 x 6
# OR: 
full_join(t3, t4, by = c("name", "gender")) # => 20 x 6
```

An alternative solution pre-supposes that both tables contain the same cases in the same order and introduces a temporary unique key variable (e.g., the row number) as key to link both tables:

```{r ex1_3b}
# Copy data: Make sure that cases are arranged in the same way:
t3 <- data_t3 %>% arrange(name, gender)
t4 <- data_t4 %>% arrange(initials, sex)

# Solution 2: When we know that 
# - both tables contain the same cases AND 
# - both tables have all cases arranged in the same way:
all.equal(t3$name, t4$initials)  # TRUE

# Add a new variable (with unique values) to both tables:
t3$nr <- 1:nrow(t3)  # add unique row number to each row
t4$nr <- 1:nrow(t4)  # add unique row number to each row

# Use this new and unambiguous variable as key:
left_join(t3, t4, by = c("nr")) %>%  # use nr as key
  select(name:bnt_1, like_2, bnt_2)  # and drop some variables => 20 x 6 
# OR: 
full_join(t3, t4, by = c("nr")) %>%  # use nr as key
  select(name:bnt_1, like_2, bnt_2)  # and drop some variables => 20 x 6 
```


## Exercise 2




# More on joining data

- Study the vignette `vignette("two-table")` for 2-table verbs, and vignette("dplyr") for 1-table verbs of `dplyr`. 

- See the [RStudio cheatsheet](https://www.rstudio.com/resources/cheatsheets/) on _Data Transformation_ for essential `dplyr` commands. 

- Follow the links on <https://dplyr.tidyverse.org> for additional information. 


# Conclusion

<!-- Table with links: -->

All [ds4psy](http://rpository.com/ds4psy/) essentials so far: 

Nr. | Topic       |
---:|:------------| 
0.  | [Syllabus](http://rpository.com/ds4psy/) | 
1.  | [Basic R concepts and commands](http://rpository.com/ds4psy/essentials/basics.html) | 
2.  | [Visualizing data](http://rpository.com/ds4psy/essentials/visualize.html) | 
3.  | [Transforming data](http://rpository.com/ds4psy/essentials/transform.html) |
4.  | [Exploring data (EDA)](http://rpository.com/ds4psy/essentials/explore.html) | 
5.  | [Tibbles](http://rpository.com/ds4psy/essentials/tibbles.html) |
6.  | [Importing data](http://rpository.com/ds4psy/essentials/import.html) |
7.  | [Tidying data](http://rpository.com/ds4psy/essentials/tidy.html) |
8.  | **Joining data** |
+.  | [Datasets](http://rpository.com/ds4psy/essentials/datasets.html) | 

<!--
Nr. | Topic       |
---:|:------------| 
0.  | [Syllabus](http://rpository.com/ds4psy/) | 
1.  | [Basic R concepts and commands](http://rpository.com/ds4psy/essentials/basics.html) | 
2.  | [Visualizing data](http://rpository.com/ds4psy/essentials/visualize.html) | 
3.  | [Transforming data](http://rpository.com/ds4psy/essentials/transform.html) |
4.  | [Exploring data (EDA)](http://rpository.com/ds4psy/essentials/explore.html) | 
5.  | [Tibbles](http://rpository.com/ds4psy/essentials/tibbles.html) |
6.  | [Importing data](http://rpository.com/ds4psy/essentials/import.html) |
7.  | [Tidying data](http://rpository.com/ds4psy/essentials/tidy.html) |
8.  | [Joining data](http://rpository.com/ds4psy/essentials/join.html) |
+.  | [Datasets](http://rpository.com/ds4psy/essentials/datasets.html) | 
-->

[Last update on `r Sys.time()` by [hn](http://neth.de/).]  

<!-- eof. --> 