---
title: "Web-based positive psychology interventions: A reexamination of effectiveness"
author: "lmw & hn"
date: "2018 11 26"
output:
   html_document:
     code_folding: show # hide
     toc: true
     toc_float: true
     toc_depth: 3
     highlight: default # textmate default kate haddock monochrome #
     lightbox: true # true by default
     fig_width: 8 # in inches
editor_options: 
  chunk_output_type: console # inline
---

```{r preamble, echo = FALSE, eval = TRUE, cache = FALSE, message = FALSE, warning = FALSE}
## (a) Housekeeping: -----
rm(list=ls()) # clean all.

## (b) Current file name and path: ----- 
# my_path <- dirname(rstudioapi::getActiveDocumentContext()$path)
# my_path
# setwd(my_path) # set to current directory
my_path <- "/Users/hneth/Desktop/stuff/Dropbox/_code/R/_teachR/ds4psy/data/_posPsy"
setwd(my_path) # set to current directory
# list.files() # all files + folders in current directory
fileName <- "wbposPsy_now.Rmd"

## (c) Packages: ----- 
library(knitr)
library(rmdformats)
library(tidyverse)

## (d) Global options: ----- 
options(max.print = "75")
opts_chunk$set(echo = TRUE,
	             cache = TRUE,
               prompt = FALSE,
               tidy = FALSE,
               collapse = TRUE, # set TRUE in answers 
               comment = "#>",
               message = FALSE,
               warning = FALSE,
               ## Default figure options:
               fig.width = 7, 
               fig.asp = .618, # golden ratio
               out.width = "75%",
               fig.align = "center"
               )
opts_knit$set(width = 75)

## (e) Custom functions: ----- 
source(file = "~/Desktop/stuff/Dropbox/_code/R/_teachR/ds4psy/R/custom_functions.R")
```

# Source data

## Reference and links

- Woodworth, R. J., O’Brien-Malone, A., Diamond, M. R. and Schüz, B. (2018). 
Data from, ‘Web-based Positive Psychology Interventions: A Reexamination of Effectiveness’. 
_Journal of Open Psychology Data_, _6_: 1. 
DOI: <https://doi.org/10.5334/jopd.35> 

- See <https://openpsychologydata.metajnl.com/articles/10.5334/jopd.35/> for details. 

- The original dataset is available from figshare at <https://doi.org/10.6084/m9.figshare.1577563.v1>.


## Preparation

```{r 2_packages, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
library(tidyverse)
# library(readxl)
library(knitr)
```

## Description of study data

The study data is stored in 2 seperate files: `participant-info.csv` & `ahi-cesd.csv`.

### File `participant-info.csv`

Contains _demographic information_ on participants:

* `id`: participant id

* `intervention`: 3 positive psychology interventions, plus 1 control condition: 

    - 1 = “Using Signature Strengths”, 
    - 2 = “Three Good Things”, 
    - 3 = “Gratitude Visit”, 
    - 4 = “Recording early memories” (control condition).  

* `sex`: 

    - 1 = female, 
    - 2 = male. 

* `age`: participant's age (in years). 

* `educ`: level of education:  

    - 1 = Less than Year 12, 
    - 2 = Year 12,
    - 3 = Vocational training, 
    - 4 = Bachelor’s degree, 
    - 5 = Postgraduate degree.

* `income`: 

    - 1 = below average, 
    - 2 = average, 
    - 3 = above average.

### File `ahi-cesd.csv`

Contains data of the 24 items of the _Authentic Happiness Inventory_ (AHI) and answers to the 20 items of the _Center for Epidemiological Studies Depression_ (CES-D) scale for (up to 6) measurement occasions. 

* `id`: Particpant ID

* `occasion`: Measurement occasion: 

    - 0 = Pretest (i.e., at enrolment), 
    - 1 = Posttest (i.e., 7 days after pretest), 
    - 2 = 1-week follow-up, (i.e., 14 days after pretest, 7 days after posttest), 
    - 3 = 1-month follow-up, (i.e., 38 days after pretest, 31 days after posttest), 
    - 4 = 3-month follow-up, (i.e., 98 days after pretest, 91 days after posttest), 
    - 5 = 6-month follow-up, (i.e., 189 days after pretest, 182 days after posttest).

* `elapsed.days`: time since enrolment measured in fractional days	

* `intervention`: intervention group

* `ahi01`--`ahi24`: responses on 24 AHI items

* `cesd01`--`cesd20`: responses on 20 CES-D items

* `ahiTotal`: total AHI score

* `cesdTotal`: total CES-D score


# Screening and cleaning data

## Import data

```{r read_data_lisa, echo = TRUE, eval = FALSE}
## Lisa:
ahi_cesd <- read_delim("~/Uni/7. Semester/HiWi/Data/Web-based positive psychology interventions/ahi-cesd.csv", ";", 
                       escape_double = FALSE, trim_ws = TRUE)

participant_info <- read_delim("~/Uni/7. Semester/HiWi/Data/Web-based positive psychology interventions/participant-info.csv", ";", 
                               escape_double = FALSE, trim_ws = TRUE)
```

```{r read_data_hans, echo = TRUE, eval = TRUE}
## Hans: 

# library(data.table)

## Get & set current path:
# cur.path <- dirname(rstudioapi::getActiveDocumentContext()$path)
# cur.path
# setwd(cur.path) # set to current directory

my_path <- "/Users/hneth/Desktop/stuff/Dropbox/_code/R/_teachR/ds4psy/data/_posPsy"

ahi_cesd <- read_delim(paste0(my_path, "/ahi-cesd.csv"), delim = ",", 
                       escape_double = FALSE, trim_ws = TRUE, col_types = cols(elapsed.days = col_double()))
ahi_cesd
# ahi_cesd$elapsed.days  # is double!

# ahi_cesd_2 <- readr::read_csv(paste0(my_path, "/ahi-cesd.csv"))
# ahi_cesd_2

participant_info <- read_delim(paste0(my_path, "/participant-info.csv"), ",",
                               escape_double = FALSE, trim_ws = TRUE)
# participant_info

# participant_info_2 <- readr::read_csv(paste0(my_path, "/participant-info.csv"))
# participant_info_2
                             
## Save data files:
## save(participant_info, file = "./data/p_info.RData")
# write_csv(participant_info, path = "/Users/hneth/Desktop/stuff/Dropbox/_code/R/_teachR/ds4psy/data/posPsy_participants.csv")
# write_csv(ahi_cesd, path = "/Users/hneth/Desktop/stuff/Dropbox/_code/R/_teachR/ds4psy/data/posPsy_AHI_CESD.csv")

## Restore data files (from online sources): ------ 

# p_info <- read_csv(file = "/Users/hneth/Desktop/stuff/Dropbox/_code/R/_teachR/ds4psy/data/posPsy_participants.csv")
p_info <- read_csv(file = "http://rpository.com/ds4psy/data/posPsy_participants.csv")  # online
# p_info
all.equal(participant_info, p_info) # should be TRUE


# AHI_CESD <- read_csv(file = "/Users/hneth/Desktop/stuff/Dropbox/_code/R/_teachR/ds4psy/data/posPsy_AHI_CESD.csv")
AHI_CESD <- read_csv(file = "http://rpository.com/ds4psy/data/posPsy_AHI_CESD.csv")  # online
# AHI_CESD

all.equal(ahi_cesd, AHI_CESD) # should be TRUE
```

## Data screening

Run some simple checks: 

- How many occasions are there for each participant?

```{r screening_1}
## Data:
# AHI_CESD

id_occ <- AHI_CESD %>%
  group_by(id, occasion) %>%
  count()
id_occ

id_occ %>%
  filter(n != 1)
# => Participants with id of 8 and 64: 
#    2 instances of occasion 2 and 4, respectively.

# Spread by occasion:
id_occ_2 <- id_occ %>%
  spread(key = occasion, value = n)
id_occ_2

id_occ_2 %>%
  filter(id == 8 | id == 64)

colSums(id_occ_2, na.rm = TRUE)

# occasion:     0     1     2     3     4     5 
# colSums:    295   147   157   139   134   120 
```

**Note:** 2 participants (8 and 64) are counted twice for an occasion (2 and 4, respectively).

Compare with Table 1 (p. 4, of Woodworth et al., 2018), which shows the number of participants who responded on each of the 6 measurement occasions):
As the counts in this table correspond to ours, the repeated instances for some measurement occasions (which could indicate data entry errors, but also be due to large variability in the time inteval between measurements) were not reported in the original analysis (i.e., Table 1). 


### Distribution of occasions

**Questions:**

- Which occasions are correct for `id == 8` and `id == 64`?

- How does the number of `elapsed.days` correspond to the measurement occasions?

- How are the measurement times (`elapsed.days`) distributed overall (and relative to the stated times of each occasion)?

```{r screening_2}
## Data:
# AHI_CESD

# From Table 1 (p. 4): 
occ_days <- c(0, 7, 14, 38, 98, 189)
names(occ_days) <- c("0: pre-test", "1: post-test", "2: 1-week", "3: 2-weeks", "4: 3-months", "5: 6-months")
occ_days

ggplot(AHI_CESD, aes(x = elapsed.days)) +
  geom_histogram(fill = "steelblue", binwidth = 1) +
  geom_vline(xintercept = occ_days, color = "firebrick", linetype = 2) +
  labs(title = "Distribution of occasions") +
  theme_bw()
```

**Note:** First 3 occasions are as expected. However, occasions 4 to 6 appear shifted to the left (i.e., were about 7 days earlier than stated).

- What is the range of measurement times (`elapsed.days`) for each occasion?

(This should show outliers and allow correcting the occasions counted twice for the 2 participants with `id` 8 and 64).

```{r screeening_3}
## Data: ----- 
# AHI_CESD
# occ_days

# Occasion 0: 0 days  ----- 

i <- 0
AHI_CESD %>%
  filter(occasion == i) %>%
  ggplot(aes(x = elapsed.days)) +
  geom_histogram(fill = "steelblue", binwidth = 1) +
  geom_vline(xintercept = occ_days[i + 1], color = "firebrick", linetype = 2) +
  labs(title = paste0("Distribution of occasion ", i, " (", names(occ_days)[i + 1], ")")) +
  theme_bw()
# => No variation, all 295 participants start with exactly 0, as expected.

# Occasion 1: 7 days ----- 

i <- 1
AHI_CESD %>%
  filter(occasion == i) %>%
  ggplot(aes(x = elapsed.days)) +
  geom_histogram(fill = "steelblue", binwidth = 1) +
  geom_vline(xintercept = occ_days[i + 1], color = "firebrick", linetype = 2) +
  labs(title = paste0("Distribution of occasion ", i, " (", names(occ_days)[i + 1], ")")) +
  theme_bw()
# => Substantial range, 2 outliers (1 at 0 = occasion 0, and 1 at 25).

# Check early outliers:
AHI_CESD %>%
  filter(occasion == 1, elapsed.days < 1)
# id = 144.

# Check late outliers:
AHI_CESD %>%
  filter(occasion == 1, elapsed.days > 24)
# id = 226.

# Occasion 2: 14 days  ----- 

i <- 2
AHI_CESD %>%
  filter(occasion == i) %>%
  ggplot(aes(x = elapsed.days)) +
  geom_histogram(fill = "steelblue", binwidth = 1) +
  geom_vline(xintercept = occ_days[i + 1], color = "firebrick", linetype = 2) +
  labs(title = paste0("Distribution of occasion ", i, " (", names(occ_days)[i + 1], ")")) +
  theme_bw()
# => Increasing range, several outliers (2 at 7 days = occasion 1, and 2 in range of 38+ days, i.e., occasion 3).

# Check early outliers:
AHI_CESD %>%
  filter(occasion == 2, elapsed.days < 8)
# id = 144 (as above), and 275 (new).

# Check late outliers:
AHI_CESD %>%
  filter(occasion == 2, elapsed.days > 38)
# id = 8 (noted above), and 232 (new).


# Occasion 3: 38 days -----

i <- 3
AHI_CESD %>%
  filter(occasion == i) %>%
  ggplot(aes(x = elapsed.days)) +
  geom_histogram(fill = "steelblue", binwidth = 1) +
  geom_vline(xintercept = occ_days[i + 1], color = "firebrick", linetype = 2) +
  labs(title = paste0("Distribution of occasion ", i, " (", names(occ_days)[i + 1], ")")) +
  theme_bw()
# => Marked shift by about 7 days to left (i.e., earlier than stated), 
#    increasing range, several outliers (but NOT in range of occasions 2 and 4).

# Check early outliers:
AHI_CESD %>%
  filter(occasion == 3, elapsed.days < 30)
# id = 144 (as above), and 76, 275 (new).

# Check late outliers:
AHI_CESD %>%
  filter(occasion == 3, elapsed.days > 50)
# id = 8 and 232 (noted above), and 199 (new).


# Occasion 4: 98 days ----- 

i <- 4
AHI_CESD %>%
  filter(occasion == i) %>%
  ggplot(aes(x = elapsed.days)) +
  geom_histogram(fill = "steelblue", binwidth = 1) +
  geom_vline(xintercept = occ_days[i + 1], color = "firebrick", linetype = 2) +
  labs(title = paste0("Distribution of occasion ", i, " (", names(occ_days)[i + 1], ")")) +
  theme_bw()
# => Marked shift by about 7 days to left (i.e., earlier than stated), 
#    increasing range, several outliers (but NOT in range of occasions 3 and 5).

# Check early outliers:
AHI_CESD %>%
  filter(occasion == 4, elapsed.days < 90)
# id = 144 (as above), and 53 (new).

# Check late outliers:
AHI_CESD %>%
  filter(occasion == 4, elapsed.days > 120)
# id = 8 and 232 (noted above), and 64 (noted above), and 180 (new).


# Occasion 5: 189 days ----- 

i <- 5
AHI_CESD %>%
  filter(occasion == i) %>%
  ggplot(aes(x = elapsed.days)) +
  geom_histogram(fill = "steelblue", binwidth = 1) +
  geom_vline(xintercept = occ_days[i + 1], color = "firebrick", linetype = 2) +
  labs(title = paste0("Distribution of occasion ", i, " (", names(occ_days)[i + 1], ")")) +
  theme_bw()
# => Marked shift by about 7 days to left (i.e., earlier than stated), 
#    increasing range, several outliers (but NOT in range of earlier occasions).

# Check early outliers:
AHI_CESD %>%
  filter(occasion == 5, elapsed.days < 181)
# => none.

# Check late outliers:
AHI_CESD %>%
  filter(occasion == 5, elapsed.days > 209)
# => 232 (noted above), and 57, 57, 197, 224 (new).

```

**Result:** The following **Table** summarizes early and late outliers (i.e., their `id`) by occasion:  

Occasion  | early | late  |
--|-------|-------| 
1 | **144**              | 226 | 
2 | **144**, **275**     | **8**, **232** | 
3 | 76, **144**, **275** | **8**, 199, **232** | 
4 | **144**              | **8**, *64*, 180, **232** | 
5 | --                   | 57, 197, 224, **232** |

Note that `id` values appearing repeatedly are shown in bold font. The `id` value of 64 is in italics, as this participant was noted above (as having 2 instances of occasion 4).


### Inspect individual participants

**Pieces of a puzzle:**

- Being early poses a bigger puzzle than being late. 

- Being consistently late could make perfect sense, if future invites depend on a minimum distance to an earlier occasion.

- Being consistently early could indicate measurement errors.

To decide how to proceed, we first _inspect_ the data of the participants noted repeatedly and _correct_ some (in a `copy` of the data).

```{r inspect_and_correct_data}
## Data: ----- 
# AHI_CESD
# occ_days

## Copy data (to keep original):
copy <- AHI_CESD

# id == 144: ----- 

AHI_CESD %>% 
  filter(id == 144) %>%
  select(id:intervention, ahiTotal, cesdTotal)

# Interpretation:
# 0 to 4 measurements, 
# Occasion 0 and 1 (pre- and post-test) were both on the same day (0).
# However, values are different: 

# Note the BIG decrease (from 18 to 8 points) in cesdTotal from occasion 0 to 1.

# Decision: 
# Leave as is. 


# id == 275: ----- 

AHI_CESD %>% 
  filter(id == 275) %>%
  select(id:intervention, ahiTotal, cesdTotal)

# Interpretation:
# Only 3 measurements, 
# Occasion 1 (post-test) is missing, 
# and time point of Occasions 2 and 3 is too early to be possible (and closer to means of earlier occasions than stated ones).

# Decision: 
# Correct copy by decrementing occasion values 2 and 3 to 1 and 2, respectively. 

copy[(copy$id == 275), ]  # original values
copy[(copy$id == 275) & (copy$occasion == 2), ]$occasion       # is 2
copy[(copy$id == 275) & (copy$occasion == 2), ]$occasion <- 1  # correct to 1
copy[(copy$id == 275) & (copy$occasion == 3), ]$occasion       # is 3
copy[(copy$id == 275) & (copy$occasion == 3), ]$occasion <- 2  # correct to 2
copy[(copy$id == 275), ]  # corrected values


# id == 8: ----- 

AHI_CESD %>% 
  filter(id == 8) %>%
  select(id:intervention, ahiTotal, cesdTotal)

# Interpretation:
# 6 measurements, but only 5 occasion values (Occasion 2 twice):
# However, elapsed.days are in order and last 2 measurements too early for Occasions 4 and 5.
# Thus, the 2nd instance of Occasion 2 could have been Occasion 3, 
# but current values of 3 and 4 cannot have been 4 and 5.

# Note lower ahiTotal values and larger cesdTotal values than previous participants.

# Decision:
# Correct copy by removing 2nd instance of Occasion 2, but leave the rest as is.
# Alternatively, we could select a random instance or average the total values of both Occasion 2 instances. 

copy  # current copy (992 rows)
copy %>% filter(id == 8)  # original lines
copy %>% filter(id == 8, occasion == 2, elapsed.days > 30)  # 1 line to be removed
copy %>% filter(!(id == 8) | !(occasion == 2) | !(elapsed.days > 30))  # the other 991 lines

copy <- copy %>% filter(!(id == 8) | !(occasion == 2) | !(elapsed.days > 30))  # remove 1 line
copy  # 991 lines remaining (qed).


# id == 64: ----- 

AHI_CESD %>% 
  filter(id == 64) %>%
  select(id:intervention, ahiTotal, cesdTotal)

# Interpretation:
# 6 measurements, but only 5 occasion values (Occasion 4 twice):
# However, elapsed.days are in order and 1st instance of Occasion 4 too late for Occasion 3 (and after start of Occasion 4).

# Decision:
# Correct copy by removing 2nd instance of Occasion 4, but leave the rest as is.
# Alternatively, we could select a random instance or average the total values of both Occasion 4 instances. 

copy  # current copy (991 rows)
copy %>% filter(id == 64)  # original lines
copy %>% filter(id == 64, occasion == 4, elapsed.days > 130)  # 1 line to be removed
copy %>% filter(!(id == 64) | !(occasion == 4) | !(elapsed.days > 130))  # the other 990 lines

copy <- copy %>% filter(!(id == 64) | !(occasion == 4) | !(elapsed.days > 130))  # remove 1 line
copy  # 990 lines remaining (qed).


# id == 232: ----- 

AHI_CESD %>% 
  filter(id == 232) %>%
  select(id:intervention, ahiTotal, cesdTotal)

# Interpretation:
# 5 measurements, Occasion 1 missing.
# However, elapsed.days are in order and correspond to stated occasions 
# (with the participant being consistently late from Occasion 2 onwards).

# Decision: 
# Leave as is.
```

**Correct** or repair data file for 3 participants and save corrected data as a `copy` (done above).


### Compare corrected and original data

Compare corrected `copy` with original data (`AHI_CESD`) and save and re-load copy (as `AHI_CESD_2`): 

```{r check_corrected_data}
## Data: ----- 
# AHI_CESD
# copy

# Dimensions: ----- 
dim(AHI_CESD) # 992 rows
dim(copy)     # 990 rows (qed)

# Compare details of original data with corrected data in copy: ----- 

AHI_CESD %>% filter(id == 8)
copy %>% filter(id == 8)      # 1 row dropped

AHI_CESD %>% filter(id == 64)
copy %>% filter(id == 64)     # 1 row dropped

AHI_CESD %>% filter(id == 275)
copy %>% filter(id == 275)    # 2 values changed (decremented)

# Save copy data:
AHI_CESD_corrected <- copy 
write_csv(AHI_CESD_corrected, path = "/Users/hneth/Desktop/stuff/Dropbox/_code/R/_teachR/ds4psy/data/posPsy_AHI_CESD_corrected.csv")

# AHI_CESD_2 <- read_csv(file = "/Users/hneth/Desktop/stuff/Dropbox/_code/R/_teachR/ds4psy/data/posPsy_AHI_CESD_corrected.csv")  # local
AHI_CESD_2 <- read_csv(file = "http://rpository.com/ds4psy/data/posPsy_AHI_CESD_corrected.csv")  # online
dim(AHI_CESD_2)  # 990 x 50

# all.equal(AHI_CESD_corrected, AHI_CESD_2)  # => should be TRUE (except for numeric format of occasion)
```


**Proceed** with _corrected_ and _re-loaded_ version of `AHI_CESD_2` data!

### Inspect corrected data

```{r inspect_data, echo = TRUE, eval = TRUE}
glimpse(p_info)
glimpse(AHI_CESD_2)

## How many occasions (lines) are there for each participant?
# AHI_CESD_2

occasions_pp <- AHI_CESD_2 %>%
  group_by(id) %>%
  summarise(n = n())

knitr::kable(head(occasions_pp))

## How many participants with all 6 occasions?
occasions_pp %>%
  filter(n == 6) %>%
  nrow()
```


### Slice and dice (from long to wide format)

Note that `ahi_cesd` consists of several blocks of data (one per `occasion`, including all participants still participating in this occasion).

#### Split `ahi_cesd` into 6 parts

Edit `ahi_cesd`: Filter each occasion into a separate data file and combine them (into a wider format) afterwards:

**Goal:** Filter 1 block for each `occasion`, containing 1 row per participant: 

```{r slice_dice, echo = TRUE, eval = TRUE}
# Create individual tibbles for every observation 
#  to later combine them using full_join()

ahi_cesd_0 <- AHI_CESD_2 %>%
  group_by(id, occasion) %>%
  filter(occasion == 0)

ahi_cesd_1 <- AHI_CESD_2 %>%
  group_by(id, occasion) %>%
  filter(occasion == 1)

ahi_cesd_2 <- AHI_CESD_2 %>%
  group_by(id, occasion) %>%
  filter(occasion == 2)

ahi_cesd_3 <- AHI_CESD_2 %>%
  group_by(id, occasion) %>%
  filter(occasion == 3)

ahi_cesd_4 <- AHI_CESD_2 %>%
  group_by(id, occasion) %>%
  filter(occasion == 4)

ahi_cesd_5 <- AHI_CESD_2 %>%
  group_by(id, occasion) %>%
  filter(occasion == 5)
```

#### Join all occasions (6 parts)

Now we can join the 6 parts by participant `id` (in wide format):

```{r join_1, echo = TRUE, eval = TRUE}
# Join parts: 
block_0_to_1 <- full_join(ahi_cesd_0, ahi_cesd_1, by = "id", suffix = c(".0", ".1"))
block_0_to_2 <- full_join(block_0_to_1, ahi_cesd_2, by = "id", suffix = c(".1", ".2"))
block_0_to_3 <- full_join(block_0_to_2, ahi_cesd_3, by = "id", suffix = c(".2", ".3"))
block_0_to_4 <- full_join(block_0_to_3, ahi_cesd_4, by = "id", suffix = c(".3", ".4"))
block_0_to_5 <- full_join(block_0_to_4, ahi_cesd_5, by = "id", suffix = c(".4", ".5"))

## check:
dim(block_0_to_5)   # => 295 x 295
```

#### Join occasions with participant data

Joining `participant_info` with `new_final`: 

```{r join_2, echo = TRUE, eval = TRUE}
complete_data <- full_join(p_info, block_0_to_5, by = "id")

## Check:
complete_data
dim(complete_data)  # => 295 x 300   
# complete_data$id[duplicated(complete_data$id)]  # => 8 and 64 NO LONGER appear twice
```

Using `left_join` instead: 

```{r left_join, echo = TRUE, eval = TRUE}
### Using left_join instead of full_join 
left_0 <- left_join(p_info, ahi_cesd_0, by = "id")
left_1 <- left_join(left_0, ahi_cesd_1, by = "id", suffix = c(".0", ".1"))
left_2 <- left_join(left_1, ahi_cesd_2, by = "id", suffix = c(".1", ".2"))
left_3 <- left_join(left_2, ahi_cesd_3, by = "id", suffix = c(".2", ".3"))
left_4 <- left_join(left_3, ahi_cesd_4, by = "id", suffix = c(".3", ".4"))

complete_data_2 <- left_join(left_4, ahi_cesd_5, by = "id", suffix = c(".4", ".5"))

## Check:
# complete_data_2
dim(complete_data_2)  # => 295 x 300
# complete_data_2$id[duplicated(complete_data_2$id)]  # => 8 and 64 NO LONGER appear twice

# all.equal(complete_data, complete_data_2) # TRUE (except for column names)
```

Proceed with `complete_data`.


#### Check for and remove redundancies

Delete redundant `intervention.*` columns, only retaining the column `intervention`:

```{r remove_redundancy, echo = TRUE, eval = TRUE}
dim(complete_data)  # 295 x 300 

all.equal(complete_data$intervention, complete_data$intervention.0)
all.equal(complete_data$intervention, complete_data$intervention.1)  # only is.NA value mismatches (due to drop outs)
all.equal(complete_data$intervention, complete_data$intervention.2)  # only is.NA value mismatches (due to drop outs)
all.equal(complete_data$intervention, complete_data$intervention.3)  # only is.NA value mismatches (due to drop outs)
all.equal(complete_data$intervention, complete_data$intervention.4)  # only is.NA value mismatches (due to drop outs)
all.equal(complete_data$intervention, complete_data$intervention.5)  # only is.NA value mismatches (due to drop outs)

## Remove redundant columns:
complete_data <- select(complete_data, -intervention.0, -intervention.1, -intervention.2, 
                                       -intervention.3, -intervention.4, -intervention.5)
dim(complete_data)  # 295 x 294 
```

Save `complete_data` as `posPsy_data_wide.csv` and re-load as `data_wide`: 

```{r save_and_reload_all_data}
## Save data files:
write_csv(complete_data, path = "/Users/hneth/Desktop/stuff/Dropbox/_code/R/_teachR/ds4psy/data/posPsy_data_wide.csv")

## Restore data files:
# data_wide <- read_csv(file = "/Users/hneth/Desktop/stuff/Dropbox/_code/R/_teachR/ds4psy/data/posPsy_data_wide.csv")
data_wide <- read_csv(file = "http://rpository.com/ds4psy/data/posPsy_data_wide.csv")  # online
data_wide
all.equal(data_wide, complete_data)  # TRUE (except for numeric type of elapsed.days.0)

# all_data$id[duplicated(data_wide$id)]  # => 8 and 64 NO LONGER appear twice
```

**Proceed** with `data_wide`. 

+++ here now +++

# Datasets

## Start from scratch

```{r clean_and_load}
# Housekeeping:
rm(list = ls())  # cleans ALL objects in current R environment (without asking for confirmation)!

# Load packages:
library(tidyverse)
library(knitr)
library(rmarkdown)

# Other customizations:
seeblau <- rgb(0, 169, 224, names = "seeblau", maxColorValue = 255)  # seeblau.4 of uni.kn color scheme 
```

## Getting the data

Some notes on the current data versions and availability of the corresponding files (from file `datasets.Rmd`).

### Files available

The following files were generated from the original data files (and saved in `.csv` format): 

1. `posPsy_participants.csv`: Original participant data (295 x 6 variables): 
<http://rpository.com/ds4psy/data/posPsy_participants.csv>. 

2. `posPsy_AHI_CESD.csv`: Original data of dependent measures in _long_ format (992 x 50 variables): 
<http://rpository.com/ds4psy/data/posPsy_AHI_CESD.csv>.

3. `posPsy_AHI_CESD_corrected.csv`: Corrected version of dependent measures in _long_ format (990 x 50 variables):
<http://rpository.com/ds4psy/data/posPsy_AHI_CESD_corrected.csv>.

4. `posPsy_data_wide.csv`: Corrected version of all data joined in _wide_ format (295 x 294 variables): 
<http://rpository.com/ds4psy/data/posPsy_data_wide.csv>. 
Different measurement occasions are suffixed by `.0`, `.1`, ..., `.5`. 


We can load the participant data into R with the following command (from the package `readr`, which is part of the `tidyverse`): 

### Loading data

Reading in these data files from online sources: 

```{r read_posPsy_data, echo = TRUE, eval = TRUE}
library(readr)

# 1. Participant data: 
p_info <- read_csv(file = "http://rpository.com/ds4psy/data/posPsy_participants.csv")  # online
dim(p_info)  # 295 x 6 

# 2. Original DVs in long format:
AHI_CESD <- read_csv(file = "http://rpository.com/ds4psy/data/posPsy_AHI_CESD.csv")  # online
dim(AHI_CESD)  # 992 x 50

# 3. Corrected DVs in long format:
AHI_CESD_2 <- read_csv(file = "http://rpository.com/ds4psy/data/posPsy_AHI_CESD_corrected.csv")  # online
dim(AHI_CESD_2)  # 990 x 50

# 4. Corrected version of all data in wide format: 
posPsy_wide <- readr::read_csv(file = "http://rpository.com/ds4psy/data/posPsy_data_wide.csv")
dim(posPsy_wide)  # 295 cases x 294 variables
```

# Data visualisation 

Some exercises using the `ggplot2` package.

**ToDo:** Put on separate page (and read in required data files).


## Exercise 1: Explore age

```{r exercise_1, echo = TRUE, eval = TRUE}
# Exercise 1: (use p_info data set)

# (a) Create a histogramm showing the overall distribution of age 
ggplot(p_info) +
  geom_histogram(mapping = aes(age), binwidth = 2, fill = "forestgreen") +
  theme_bw() +
  labs(title = "Distribution of age values")

# (b) Can you display the distribution also as frequency polygon?
ggplot(data = p_info) +
  geom_freqpoly(mapping = aes(x=age), binwidth = 4, fill = "forestgreen", color = "grey") + 
  labs(title = "Distribution of age",
       x="Age", y = "Count") +
  theme_bw()
  
# (c) Create a stacked histogramm showing the distribution of age by intervention
ggplot(p_info) +
  geom_histogram(mapping = aes(age,  fill = intervention, position = "stack"), binwidth = 3) +
  theme_bw() +
  labs(title = "Distribution of age values by intervention")

# (d) Create 4 histogramms showing the distribution of age by intervention 
ggplot(p_info) +
  geom_histogram(mapping = aes(age), binwidth = 5, fill = "forestgreen") +
  theme_bw() +
  labs(title = "Distribution of age values by intervention") +
  facet_grid(.~intervention)

# (e) Create a histogramm and a frequency polygon showing how age is distributed amongst the male and female participants
p_info$sex <- as.factor(p_info$sex)

ggplot(data = p_info) +
  geom_histogram(mapping = aes(x=age, fill = sex), binwidth = 5) +
  labs(title = "Distribution of age",
       x="Age", y = "Count") +
  theme_bw()

ggplot(data = p_info) +
  geom_freqpoly(mapping = aes(x=age, color = sex), binwidth = 4) +
  labs(title = "Distribution of age",
       x="Age", y = "Count") +
  theme_bw()
```


## Exercise 2: Explore participants - intervention groups

```{r exercise_2, echo = TRUE, eval = TRUE}
# Exercise 2: Are the participants equally dirtributed over the 4 intervention categories?
# (a): in total counts
# (b): in %

# # use p_info dataset
# # load data
# p_info <- read_csv(file = "http://rpository.com/ds4psy/data/posPsy_participants.csv")  
# dim(p_info)  # 295 x 6 

## (2a)
p_info$intervention <- as.factor(p_info$intervention)
ggplot(p_info) +
  geom_bar(mapping = aes(x = intervention),  fill = "darkblue") + 
  labs(title = "Participants per intervention group", x="Intervention", y = "Count") +
  theme_minimal()


# (additional task): Every bar should have a different color.How do you do this?

ggplot(p_info) +
  geom_bar(mapping = aes(x = intervention, fill = intervention)) + 
  labs(title = "Participants per intervention group", x="Intervention", y = "Count") +
  theme_minimal()


## (2b)
ggplot(p_info) +
  geom_bar(mapping = aes(x = intervention,y = ..prop.., group = 1), fill = "darkblue") +   labs(title = "Distribution of participants over intervention groups", x="Intervention", y = "Proportion") +
  theme_minimal()

```

## Exercise 3: Gender per intervention

Is the distribution of gender similar within the intervention groups?

```{r exercise_3, echo = TRUE, eval = TRUE}
# Exercise 3: Is the distribution of gender similar within the intervention groups?

ggplot(p_info) +
  geom_bar(mapping = aes(x = intervention, fill = sex), position = "dodge") + 
  labs(title = "Participants per intervention group", x="Intervention", y = "Count") +
  theme_minimal()

```

## Exercise 4: Scores

Explore `ahiTotal` and `cesdTotal` scores at different occasions. 

```{r exercise_4, echo = TRUE, eval = TRUE}
# Exercise 4

# load data
data_wide <- read_csv(file = "http://rpository.com/ds4psy/data/posPsy_data_wide.csv") 
dim(data_wide)  # 295 x 294 

## (4a): Show the relationship of ahiTotal and cesdTotal at Occasion 0 using a scatterplot

ggplot(data = data_wide) +
  geom_point(mapping = aes(x = ahiTotal.0, y = cesdTotal.0)) + 
  #adding title and axis labels
  labs(title = "Relationship between ahiTotal and cesdTotal at Occasion = 0", 
       x ="ahiTotal", y = "cesdTotal") +
  theme_minimal()


## (4b): Add the trend-line to this plot
ggplot(data = data_wide, mapping = aes(x = ahiTotal.0, y = cesdTotal.0)) +
  geom_point() + 
  geom_smooth() +
  labs(title = "Relationship between ahiTotal and cesdTotal at Occasion = 0", 
       x ="ahiTotal", y = "cesdTotal") +
  theme_minimal()

## (4c): Make this plot look nicer, for example by using color or changing the pointshape or size.

ggplot(data = data_wide) +
  geom_point(mapping = aes(x = ahiTotal.0, y = cesdTotal.0),color = "darkblue", shape = 18, size=3, alpha = .4) + 
  labs(title = "Relationship between ahiTotal and cesdTotal at Occasion = 0", 
       x ="ahiTotal", y = "cesdTotal") +
  theme_minimal()

  
## (4d): Add information on intervention group using 2 different options

##prep: intervention as factor not as integer
data_wide$intervention <- as.factor(data_wide$intervention)

## 1 Plot, 4 colors: 
 ggplot(data = data_wide) +
  geom_point(mapping = aes(x = ahiTotal.0, y = cesdTotal.0, color = intervention)) + 
  labs(title = "Relationship between ahiTotal and cesdTotal at Occasion = 0",
       x="ahiTotal", y = "cesdTotal") 
 
## 4 plots: 
ggplot(data = data_wide) +
  geom_point(mapping = aes(x = ahiTotal.0, y = cesdTotal.0)) + 
  labs(title = "Relationship between ahiTotal and cesdTotal at Occasion = 0",
       x="ahiTotal", y = "cesdTotal") +
    theme_minimal() +
    facet_grid(.~ intervention)
  
 
## (4e): Let's create 4 plots (hint: facet_grid) for occasion 5 and compare them to the one for occasion 0. What has changed?
  
# Relationship ahiTotal and cesdTotal at Occasion = 5 
 
ggplot(data = data_wide) +
  geom_point(mapping = aes(x = ahiTotal.5, y = cesdTotal.5)) + 
  labs(title = "Relationship between ahiTotal and cesdTotal at Occasion = 5",
       x="ahiTotal", y = "cesdTotal") +
      theme_minimal() +
    facet_grid(.~ intervention)
    
ggplot(data = data_wide) +
  geom_point(mapping = aes(x = ahiTotal.5, y = cesdTotal.5, color = intervention)) + 
  labs(title = "Relationship between ahiTotal and cesdTotal at Occasion = 5",
       x="ahiTotal", y = "cesdTotal") +
          theme_minimal()
```

## Exercise 5: Violins

```{r exercise_5, echo = TRUE, eval = TRUE}
# Exercise 5:

## load data:
# data_wide <- read_csv(file = "http://rpository.com/ds4psy/data/posPsy_data_wide.csv") 
# dim(data_wide)  # 295 x 294 

## (5a): Plot the distribution of pre-intervention ahiTotal-scores (Occasion = 0) grouped by income level using a violin plot
data_wide$income <- as.factor(data_wide$income)
ggplot(data = data_wide, mapping = aes(x = income,y = ahiTotal.0)) +
  geom_violin() +
  labs(title = "Comparison of pre-intervention ahiTotal-scores at for income levels", x = "income category", y = "pre-intervention ahiTotal-scores" ) +
  theme_classic()

## (5b): Can you add information about how the participants are distributed with in each income group using geom_jitter? 

ggplot(data = data_wide, mapping = aes(x = income,y = ahiTotal.0)) +
  geom_violin(color = "darkblue") +
  geom_jitter(color = "lightblue", size = 2) +
  labs(title = "Comparison of pre-intervention ahiTotal-scores at for income levels", x = "income category", y = "pre-intervention ahiTotal-scores" ) +
  theme_classic()

## (5c): Can you do the same plot with geom_point, instead of geom_jitter?
ggplot(data = data_wide, mapping = aes(x = income,y = ahiTotal.0)) +
  geom_violin() +
  geom_point(position = "jitter", color = "lightblue", size = 2) +
  labs(title = "Comparison of pre-intervention ahiTotal-scores at for income levels", x = "income category", y = "pre-intervention ahiTotal-scores" ) +
  theme_classic()

## (5d): Let?s see how the pre-intervention cesdTotal-scores are distributed in the income groups
ggplot(data = data_wide, mapping = aes(x = income,y = cesdTotal.0)) +
  geom_violin(color = "darkblue") +
  geom_jitter(color = "lightblue", size = 2) +
  labs(title = "Comparison of pre-intervention cesdTotal-scores at for income levels", x = "income category", y = "pre-intervention cesdTotal-scores" ) +
  theme_classic()
```

## Exercise 6: Scatterplots

Explore data - ahiTotal scores, cesdTotal scores and age

```{r exercise_6, echo = TRUE, eval = TRUE}
# Exercise 6: Create two scatterplot to investigate if there is an systematic relationship between ahiTotal scores/cesdTotal scores and age.

## load data:
# data_wide <- read_csv(file = "http://rpository.com/ds4psy/data/posPsy_data_wide.csv") 
# dim(data_wide)  # 295 x 294

## (6a): ahiTotal scores
ggplot(data_wide, mapping = aes(x = age, y = ahiTotal.0)) +
  geom_point(color = "forestgreen", shape = 1, size = 1.5) +
  labs(title = "Age and ahiTotal scores before start of interventions", x = "age", y = "Pre-intervention ahiTotal Score")

## (6b): cesdTotal-scores
ggplot(data_wide, mapping = aes(x = age, y = cesdTotal.0)) +
  geom_point(color = "forestgreen", shape = 1, size = 1.5) +
  labs(title = "Age and cesdTotal scores before start of interventions", x = "age", y = "Pre-intervention cesdTotal Score")

```

# Data transformation

Some exercises using the `dplyr` package.

**ToDo:** Put on separate page (and read in required data files).


# EDA

What is _exploratory data analysis_ (EDA)?

1. Generate questions about your data.
2. Search for answers by visualising, transforming, and modelling your data.
3. Use what you learn to refine your questions and/or generate new questions.



### Exercises on EDA:

Some exercises using the `dplyr` and `ggplot2` packages.

**ToDo:** Put on separate page (and read in required data files).


## Exercise 1

a. How many participants are in each intervention group? Are the participants distributed equally? 
(Find the solution both graphically and by using data transformation.) 

b. Show the distribution of `age` values for both women and men.

c. Provide descriptive statistics (i.e., mean, sd, min, max, etc.) for the `age` values for every intervention group.

```{r ex1_eda, echo = TRUE, eval = TRUE}
# Exercise 1: 

# Load participant data: 
p_info <- readr::read_csv(file = "http://rpository.com/ds4psy/data/posPsy_participants.csv")
dim(p_info)  # 295 x 6 

# (a) How many participants are in each intervention group? Are the participants distributed equally?
#     (Find the solution both graphically and by using data transformation.) 

ggplot(p_info) +
  geom_bar(mapping = aes(x = intervention), position = "dodge", fill = "darkblue") + 
  labs(title = "Participants per intervention group", x = "Intervention", y = "Count") +
  theme_minimal()

p_info %>%
  group_by(intervention) %>% 
  count()

# (b): Show distribution of age for women and men.

p_info$sex <- as.factor(p_info$sex)

ggplot(p_info, mapping = aes(x=age)) +
  geom_density(aes(color= sex)) +
  labs(title = "Distribution of age for men and women", x = "Age", y= "Density") +
  theme_minimal()

# (2c): What is the mean age and sd of age for every intervention group?

p_info %>%
  group_by(intervention) %>% 
  summarize(mean_age = mean(age, na.rm = TRUE), 
            sd_age = sd(age, na.rm = TRUE))
```

## Exercise 2

- Explore how the distribution of of ahi total scores shifted from occasion 0 to 5. Why? Does that match your expectations?
- Can you see any unusual patterns? What might explain them? 

```{r ex2_eda, echo = TRUE, eval = TRUE}
# Exercise 2:  
## (2a):Explore how the distribution of of ahi total scores shifted from occasion 0 to 5. Why? Does that match your expectations?
## Can you see any unusual patterns? What might explain them? 

## First, load data in the best suited format and delete redundant colums.

# load data: 
data_wide <- read_csv(file = "http://rpository.com/ds4psy/data/posPsy_data_wide.csv")  # online
dim(data_wide) 

# select colums of interest: 
data_wide <- select(data_wide, id:elapsed.days.0, contains("Total"), contains("occasion"), starts_with("elapsed."))

# View(data_wide)

ggplot(data_wide) +
  geom_freqpoly(mapping = aes(ahiTotal.0), color = "darkblue", binwidth = 2) +
  geom_freqpoly(mapping = aes(ahiTotal.5), color = "forestgreen", binwidth = 2) +
  theme_minimal() +
  labs(title = "AHI TOTAL SCORE DISTRIBUTION CHANGE", x = "AHI TOTAL SCORES", y = "COUNT")
```

## Exercise 3

```{r ex3_eda, echo = TRUE, eval = TRUE}
# Exercise 3:Let`s create plots of the improvement in ahitotal scores and cesdtotal in the course of the study (occasion 0 - occasion 5) with information on intervention groups. 

## In preparation for this expercise load required data.  and create a tibble containing the information needed (mean scores per intervention group for every occasion, info on intervention group, info on occasion)
 
# load data
AHI_CESD_2 <- read_csv(file = "http://rpository.com/ds4psy/data/posPsy_AHI_CESD_corrected.csv")


## (3a): How did the mean ahiscore change in the course of the study?
a <- AHI_CESD_2 %>% 
  group_by(occasion) %>% 
  summarize(mean_ahi = mean(ahiTotal, na.rm = TRUE),
            mean_cesd = mean(cesdTotal, na.rm = TRUE))

ggplot(a, mapping = aes(x=occasion, y= mean_ahi)) + 
  geom_point(mapping = aes(size = 1.5), color = "darkblue") +
  geom_line(color = "grey") +
  ggtitle("Ahi-scores in course of study") +
  theme_bw()

## (3b): How did the mean ahiscore change in the course of the study grouped by intervention?
## Create a tibble containing the information needed first. (mean scores per intervention group for every occasion, info on intervention group, info on occasion). 

# new tibble containing required data
b <- AHI_CESD_2 %>% 
  group_by(intervention, occasion) %>% 
  summarize(mean_ahi = mean(ahiTotal, na.rm = TRUE),
            mean_cesd = mean(cesdTotal, na.rm = TRUE))
b

ggplot(b, mapping = aes(x=occasion, y= mean_ahi, color = intervention)) +
  geom_point(mapping = aes(size = 1.5)) +
  geom_line() +
  ggtitle("Mean ahi-score per intervention group over time")

# Why is the coloring not the way we want it to be?
b$intervention <- as.factor(b$intervention)

# Try again
ggplot(b, mapping = aes(x=occasion, y= mean_ahi, color = intervention)) +
  geom_point(mapping = aes(size = 1.5)) +
  geom_line() +
  ggtitle("Mean ahi-score per intervention group over time") +
  theme_minimal()

## (3c): Can you combin both plots in one?

ggplot() +
  geom_point(b, mapping = aes(x=occasion, y= mean_ahi, size = 1.1, color = intervention)) +
  geom_line(b, mapping = aes(x=occasion, y= mean_ahi, color = intervention)) +
  geom_point(a, mapping = aes(x=occasion, y= mean_ahi,size = 1), shape = 15) +
  geom_line(a, mapping = aes(x=occasion, y= mean_ahi, size = 1)) +
  ggtitle("Mean ahi-scores over time") +
  theme_light()

## (3d): What was the intervention for group 3? Is the time course reasonable?
# Group 3 had to write a thankyou letter and deliver it in person. This can explain the improvement from occasion 0 to 1. Afterwards they did not have any further tasks. The attained happiness through the letter and it`s delivery happens to decrease again. Very interessting that there is an increase from occasion 4 to 5 again. 

## (3e): Create the same plot as in exercise 3c for the cesd scores.
ggplot() +
  geom_point(b, mapping = aes(x=occasion, y= mean_cesd, size = 1, color = intervention)) +
  geom_line(b, mapping = aes(x=occasion, y= mean_cesd, color = intervention)) +
  geom_point(a, mapping = aes(x=occasion, y= mean_cesd,size = 0.7), shape = 15) +
  geom_line(a, mapping = aes(x=occasion, y= mean_cesd, size = 0.7)) +
  ggtitle("Mean cesd-scores over time") +
  theme_light()


## What implies the plot about the interventions?
## In three groups, the depression scores first decrease but then increas again towards the end. It could be the case that the intervention first succeed, but then they loose their power in course of the time.
ggplot() +
  geom_point(b, mapping = aes(x=occasion, y= mean_cesd, size = 1, color = intervention)) +
  geom_line(b, mapping = aes(x=occasion, y= mean_cesd, color = intervention)) +
  geom_point(a, mapping = aes(x=occasion, y= mean_cesd,size = 0.7), shape = 15) +
  geom_line(a, mapping = aes(x=occasion, y= mean_cesd, size = 0.7)) +
  ggtitle("Mean cesd-scores over time") +
  theme_light()
```

## Exercise 4

```{r ex4_eda, echo = TRUE, eval = TRUE}
# Exercise 4:  
## (4a): Create new variables indicating the improvement in ahi scores from occasion 0 to occasion 1, from occasion 1 to occasion 2, and so on. 
## First, load data in the best suited format and delete redundant colums.

#load data
data_wide <- read_csv(file = "http://rpository.com/ds4psy/data/posPsy_data_wide.csv")  # online
dim(data_wide) 

#select colums of interest
data_wide <- select(data_wide, id:elapsed.days.0, contains("Total"), contains("occasion"), starts_with("elapsed."))

#new variables

data_wide <- data_wide %>% 
  mutate(improve01ahi = ahiTotal.1 - ahiTotal.0, 
         improve12ahi = ahiTotal.2 - ahiTotal.1, 
         improve23ahi = ahiTotal.3 - ahiTotal.2,
         improve34ahi = ahiTotal.4 - ahiTotal.3,
         improve45ahi = ahiTotal.5 - ahiTotal.4)
dim(data_wide)#295 35


##(4b): Compute the mean improvements per intervention group
data_wide %>% 
  group_by(intervention) %>% 
  summarise(mean_improve01_i = mean(improve01ahi, na.rm = TRUE), 
            mean_improve12_i = mean(improve12ahi, na.rm = TRUE),
            mean_improve23_i = mean(improve23ahi, na.rm = TRUE),
            mean_improve34_i = mean(improve34ahi, na.rm = TRUE),
            mean_improve45_i = mean(improve45ahi, na.rm = TRUE))

##(4c): What is surprising about the results? 
#There are also negative improvements.


##(4d): Do women and men differ in their improvements?
#Try to find the solution graphically first. Then have a look on the numbers.
data_wide %>%
  group_by(intervention, sex) %>% 
  summarise(mean_improve01_i = mean(improve01ahi, na.rm = TRUE), 
            mean_improve12_i = mean(improve12ahi, na.rm = TRUE),
            mean_improve23_i = mean(improve23ahi, na.rm = TRUE),
            mean_improve34_i = mean(improve34ahi, na.rm = TRUE),
            mean_improve45_i = mean(improve45ahi, na.rm = TRUE))
```

## Exercise 5

```{r exercise 5, echo = TRUE, eval = TRUE}
# Exercise 5:  
# (5a): Is there a difference in total improve regarding gender?

d <- data_wide %>%
  mutate(change_ahi = ahiTotal.5 - ahiTotal.0,
         change_cesd = cesdTotal.5 - cesdTotal.0)

d %>%
  group_by(sex) %>% 
  summarize(mean_change_ahi = mean(change_ahi, na.rm = TRUE), 
            mean_change_cesd = mean(change_cesd, na.rm = TRUE))


# (5c): Are there interventions which are more effective for men or women?
# Use data transformation commands to find the solution first, then create two plots (one for ahi and one for cesd scores)
e <- d%>%
  group_by(sex, intervention) %>% 
  summarize(mean_change_ahi = mean(change_ahi, na.rm = TRUE), 
            mean_change_cesd = mean(change_cesd, na.rm = TRUE))


# Change in ahi Scores
e$sex <- as.factor(e$sex)
ggplot(e) +
  geom_point(aes(x = intervention, y =mean_change_ahi, color = sex)) +
  labs(title = "Mean change in ahi scores for men and women", x = "intervention", y = "Change in ahi scores (mean)") +
  theme_light() +
  geom_hline(yintercept = 0)

# Change in cesd Scores
e$sex <- as.factor(e$sex)
ggplot(e) +
  geom_point(aes(x = intervention, y =mean_change_cesd, color = sex)) +
  labs(title = "Mean change in cesd scores for men and women", x = "intervention", y = "Change in cesd scores (mean)") +
  theme_light() +
  geom_hline(yintercept = 0)

```


## Exercise 6

```{r exercise 6, echo = TRUE, eval = TRUE}
# Exercise 6: Dropout  
## (6a): How many participants dropped out at occasion 1, occasion 2, ..., occasion 5? (Dropout means "NA" at all remaining occasions, not only at one)

# load data
data_wide <- read_csv(file = "http://rpository.com/ds4psy/data/posPsy_data_wide.csv") 
dim(data_wide) #295 294


# Dropout at occasion 1

data_wide %>% 
  filter(is.na(occasion.1) & is.na(occasion.2) & is.na(occasion.3) & is.na(occasion.4) & is.na(occasion.5)) %>% 
  count() #93

#Dropout at occasion 2

data_wide %>% 
  filter(!is.na(occasion.1) & is.na(occasion.2) & is.na(occasion.3) & is.na(occasion.4) & is.na(occasion.5)) %>% 
  count() #23

#Dropout at occasion 3

data_wide %>% 
  filter(!is.na(occasion.1) & !is.na(occasion.2) & is.na(occasion.3) & is.na(occasion.4) & is.na(occasion.5)) %>% 
  count() #8


#Dropout at occasion 4

data_wide %>% 
  filter(!is.na(occasion.1) & !is.na(occasion.2) & !is.na(occasion.3) & is.na(occasion.4) & is.na(occasion.5)) %>% 
  count() #4

#Dropout at occasion 5

data_wide %>% 
  filter(!is.na(occasion.1) & !is.na(occasion.2) & !is.na(occasion.3) & !is.na(occasion.4) & is.na(occasion.5)) %>% 
  count() #15


## (6b): How many participants dropped out in total?
93+23+8+4+5 #133
```


## Exercise 7

```{r exercise 7, echo = TRUE, eval = TRUE}
#Exercise 7: Participants with stable scores 
##You computed new variables with information on the changes in ahi and cesd total scores from occasion 0 to occasion 5 in exercise 5. Compute the variables again or take the data from exercise 5

data_wide <- read_csv(file = "http://rpository.com/ds4psy/data/posPsy_data_wide.csv") 
dim(data_wide) #295 294

data_wide <- select(data_wide, id:elapsed.days.0, contains("Total"), contains("occasion"), starts_with("elapsed."))

e <- data_wide %>% 
  mutate(change_ahi = ahiTotal.5 - ahiTotal.0,
         change_cesd = cesdTotal.5 - cesdTotal.0)

##(7a): Are there participants whose ahiTotal scores did not change? If yes: how many are there?
e %>%
  filter(change_ahi == 0) #yes

e %>%
  filter(change_ahi == 0) %>% 
  count() #5

##(7b): Are there participants whose cesdTotal scores did not change? If yes: how many are there?
e %>%
  filter(change_cesd == 0) #yes

e %>%
  filter(change_cesd == 0) %>% 
  count() #8


##(7c): Are there participants whose ahiTotal score and cesdTotal score did not change? If yes: how many are there?
e %>%
  filter(change_cesd == 0, change_ahi == 0) #yes

e %>%
  filter(change_cesd == 0, change_ahi == 0) %>% 
  count() #1


##(7d): Who is it?
e %>%
  filter(change_cesd == 0, change_ahi == 0) %>% 
  select(id)

#participant with id 113


##(7e): For this particpiant plot the scores over time.

AHI_CESD_2 <- read_csv(file = "http://rpository.com/ds4psy/data/posPsy_AHI_CESD_corrected.csv")  
dim(AHI_CESD_2) #990 50


AHI_CESD_2 <- AHI_CESD_2 %>% 
  filter(id == "113")
AHI_CESD_2

ggplot(AHI_CESD_2) +
  geom_point(aes(x = occasion, y = ahiTotal), color = "darkblue", size = 2) +
  geom_line(aes(x = occasion, y = ahiTotal), color = "darkblue") +
  geom_point(aes(x = occasion, y = cesdTotal), color = "forestgreen", size = 2) +
  geom_line(aes(x = occasion, y = cesdTotal), color = "forestgreen") +
  labs(title = "Participant 113 ahiTotal scores (blue) and cesdTotalscores (green) over time", x = "occasion", y = "Total scores") +
  theme_light()
```



# References

- Seligman, M. E., Steen, T. A., Park, N., & Peterson, C. (2005). 
Positive psychology progress: Empirical validation of interventions. 
_American Psychologist_, _60_(5), 410--421.

- Woodworth, R. J., O'Brien‐Malone, A., Diamond, M. R., & Schüz, B. (2017). 
Web‐based positive psychology interventions: A reexamination of effectiveness. 
_Journal of Clinical Psychology_, _73_(3), 218--232.

- Woodworth, R. J., O’Brien-Malone, A., Diamond, M. R. and Schüz, B. (2018). 
Data from, ‘Web-based positive psychology interventions: A reexamination of effectiveness’. 
_Journal of Open Psychology Data_, _6_: 1. DOI: <https://doi.org/10.5334/jopd.35> 

- Data at <https://doi.org/10.6084/m9.figshare.1577563.v1>. 


[Last update on `r Sys.time()` by [hn](http://neth.de/).] 

<!-- eof. --> 